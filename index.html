<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive 3-Year TCO Analysis Dashboard for 59 cars with NEW vs USED comparison using real KBB & Edmunds data">
    <meta name="keywords" content="car analysis, TCO, total cost ownership, car buying, depreciation, automotive">
    <title>Ultimate Car Analysis Dashboard - 3-Year TCO Comparison</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #0f1419;
            --secondary-bg: #1a1f29;
            --card-bg: #242937;
            --surface-bg: #2d3748;
            --accent-blue: #3182ce;
            --accent-green: #38a169;
            --accent-orange: #dd6b20;
            --accent-red: #e53e3e;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(90deg, #3182ce 0%, #63b3ed 100%);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: var(--spacing-sm);
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            body {
                padding: var(--spacing-lg);
                font-size: 16px;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--secondary-bg);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 25px 80px var(--shadow-color);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
            z-index: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
                margin: var(--spacing-xs);
                border-radius: var(--border-radius-md);
            }
        }
        
        h1 {
            text-align: center;
            color: var(--text-primary);
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            margin-bottom: var(--spacing-xs);
            font-weight: 700;
            letter-spacing: -0.025em;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            margin-bottom: var(--spacing-xl);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        .subtitle .warning-text {
            color: var(--accent-red);
            font-weight: 600;
            display: block;
            margin-top: var(--spacing-xs);
        }
        
        .refresh-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: var(--spacing-sm);
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .refresh-btn:hover {
            background: var(--accent-green);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .refresh-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            margin-left: 4px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--card-bg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            position: sticky;
            top: var(--spacing-sm);
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
                padding: var(--spacing-md);
                position: static;
            }
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: var(--spacing-xs);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .filter-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            background: var(--surface-bg);
            color: var(--text-primary);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .filter-group select:hover {
            border-color: var(--accent-blue);
            background: var(--secondary-bg);
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: var(--spacing-sm);
            }
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform var(--transition-normal);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px var(--shadow-color);
            border-color: var(--accent-blue);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        @media (max-width: 768px) {
            .stat-card {
                padding: var(--spacing-md);
            }
        }
        
        .stat-number {
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(500px, 100%), 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }
        }
        
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px var(--shadow-color);
            transition: all var(--transition-normal);
            position: relative;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px var(--shadow-color);
            border-color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .chart-container {
                padding: var(--spacing-md);
            }
        }
        
        .chart-title {
            font-size: clamp(1rem, 3vw, 1.25rem);
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            letter-spacing: -0.025em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }
        
        .chart-canvas {
            position: relative;
            height: clamp(300px, 50vw, 450px);
            width: 100%;
        }
        
        canvas {
            max-height: 450px !important;
            border-radius: var(--border-radius-sm);
        }

        @media (max-width: 768px) {
            .chart-canvas {
                height: 300px;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            animation: modalFadeIn var(--transition-normal) ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(8px);
            }
        }
        
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            margin: 2% auto;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 80px var(--shadow-color);
            animation: modalSlideIn var(--transition-normal) ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: var(--spacing-lg);
                max-height: 85vh;
            }
        }
        
        .close {
            color: var(--text-secondary);
            position: absolute;
            right: var(--spacing-lg);
            top: var(--spacing-lg);
            font-size: 24px;
            font-weight: 500;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--surface-bg);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: var(--text-primary);
            background: var(--accent-red);
            border-color: var(--accent-red);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .close {
                right: var(--spacing-md);
                top: var(--spacing-md);
            }
        }
        
        .car-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .detail-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .detail-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .detail-value {
            font-size: 1.2em;
            color: #34495e;
            margin-bottom: 5px;
        }
        
        .detail-breakdown {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #856404;
        }
        
        .warning-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .table-container {
            margin-top: var(--spacing-xl);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 700px;
                font-size: 0.75rem;
            }
        }
        
        .data-table th {
            background: var(--surface-bg);
            color: var(--text-primary);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .data-table th {
                padding: var(--spacing-sm);
                font-size: 0.7rem;
            }
        }
        
        .data-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-primary);
        }
        
        .data-table tr:hover {
            background: var(--surface-bg);
            transform: scale(1.01);
        }

        .data-table tr:hover td {
            border-color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .data-table td {
                padding: var(--spacing-sm);
            }
        }

        /* NEW VS USED Comparison Section Styles */
        .comparison-section {
            background: linear-gradient(135deg, var(--accent-red), #ee5a24);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin: var(--spacing-xl) 0;
            box-shadow: 0 15px 40px rgba(238, 90, 36, 0.3);
            position: relative;
            overflow: hidden;
        }

        .comparison-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }

        .comparison-title {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            position: relative;
            z-index: 1;
        }

        .comparison-card {
            background: rgba(255, 255, 255, 0.15);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all var(--transition-normal);
        }

        .comparison-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .comparison-card-title {
            margin-bottom: var(--spacing-md);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .comparison-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .savings-highlight {
            text-align: center;
            margin-top: var(--spacing-md);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-green);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .strategy-tip {
            text-align: center;
            margin-top: var(--spacing-xl);
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.2);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .comparison-section {
                padding: var(--spacing-lg);
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .comparison-details {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
        }

        /* Loading states and animations */
        .loading {
            cursor: wait;
        }

        .loading .chart-container,
        .loading .stats-grid,
        .loading .table-container {
            transition: opacity var(--transition-normal);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .chart-container.loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Improved focus states for accessibility */
        .stat-card:focus,
        .chart-container:focus,
        .data-table tr:focus {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background var(--transition-fast);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #ffffff;
                --text-secondary: #ffffff;
                --shadow-color: rgba(255, 255, 255, 0.3);
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .container {
                box-shadow: none;
                border: 1px solid black;
            }
            
            .modal,
            .filters {
                display: none;
            }
        }

        /* Initial loading state */
        body:not(.loaded) {
            overflow: hidden;
        }

        body:not(.loaded)::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-bg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body:not(.loaded)::after {
            content: 'Loading Dashboard...';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 500;
            z-index: 10000;
            animation: pulse 2s infinite;
        }

        /* Smooth reveal animation */
        .loaded .container {
            animation: containerReveal 0.8s ease-out;
        }

        @keyframes containerReveal {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced micro-interactions */
        .stat-card,
        .chart-container,
        .comparison-card {
            will-change: transform;
        }

        .filter-group select:active {
            transform: scale(0.98);
        }

        .data-table tr:active {
            transform: scale(0.995);
        }

        /* Focus visible for better accessibility */
        .filter-group select:focus-visible,
        .stat-card:focus-visible,
        .chart-container:focus-visible,
        .data-table tr:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Ultimate Car Analysis Dashboard</h1>
        <p class="subtitle">
            <strong>3-Year TCO Analysis: Multiple Model Years & Real Market Data</strong><br>
            <span class="header-subtitle">Compare used vs new across different model years | KBB & Edmunds pricing</span><br>
            TCO = Purchase Price + Depreciation Loss + Fuel + Maintenance + Insurance (3 years)<br>
            <button id="refreshDataBtn" class="refresh-btn" onclick="refreshData()" title="Refresh live price data">
                üîÑ Refresh Live Prices
            </button>
        </p>
        
        <div class="filters">
            <div class="filter-group">
                <label for="budgetFilter">Budget Range</label>
                <select id="budgetFilter">
                    <option value="all">All Budgets</option>
                    <option value="under20k">Under $20k</option>
                    <option value="20to30k">$20k - $30k</option>
                    <option value="30to40k">$30k - $40k</option>
                    <option value="40to50k">$40k - $50k</option>
                    <option value="over50k">Over $50k</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="fuelFilter">Fuel Type</label>
                <select id="fuelFilter">
                    <option value="all">All Types</option>
                    <option value="Electric">Electric</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="PHEV">PHEV</option>
                    <option value="Gas">Gas</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="reliabilityFilter">Min Reliability</label>
                <select id="reliabilityFilter">
                    <option value="all">All Ratings</option>
                    <option value="6">6+ Rating</option>
                    <option value="7">7+ Rating</option>
                    <option value="8">8+ Rating</option>
                    <option value="9">9+ Rating</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="brandFilter">Brand</label>
                <select id="brandFilter">
                    <option value="all">All Brands</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="yearFilter">Model Year</label>
                <select id="yearFilter">
                    <option value="all">All Years</option>
                    <option value="2024">2024 (Latest)</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017-2018">2017-2018 (Older)</option>
                    <option value="new">2023-2024 (New)</option>
                    <option value="recent">2021-2022 (Recent)</option>
                    <option value="older">2018-2020 (Value)</option>
                </select>
            </div>
        </div>

        <!-- Manual Car Entry Tab -->
        <div class="manual-entry-tab" style="margin: 30px 0;">
            <button id="toggleManualEntry" onclick="toggleManualEntryForm()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 15px 25px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); transition: all 0.3s ease; width: 100%;">
                üöó Add Custom Car (Click to Open)
            </button>
            
            <div id="manualEntryForm" class="manual-entry-container" style="display: none; margin-top: 15px; padding: 25px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">
                <h3 style="margin: 0 0 20px 0; font-size: 1.3em; text-align: center;">üîß Add Your Own Car</h3>
                <p style="text-align: center; margin: 0 0 20px 0; opacity: 0.9;">Found a car not in our database? Add it manually and it'll appear in all charts!</p>
                
                <div class="manual-entry-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Brand*</label>
                        <select id="manualBrand" onchange="updateBrandField(); autoCalculateValues();" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                            <option value="">Select Brand...</option>
                        </select>
                        <input type="text" id="manualBrandCustom" placeholder="Type new brand..." style="display: none; width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; margin-top: 5px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Model*</label>
                        <input type="text" id="manualModel" placeholder="e.g. Model 3, 330i, Camry" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Year*</label>
                        <input type="number" id="manualYear" placeholder="2023" min="2015" max="2025" value="2023" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Price ($)*</label>
                        <input type="number" id="manualPrice" placeholder="25000" min="5000" max="200000" onchange="autoCalculateValues();" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Fuel Type*</label>
                        <select id="manualFuel" onchange="autoCalculateValues();" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                            <option value="">Select...</option>
                            <option value="Gas">Gas</option>
                            <option value="Hybrid">Hybrid</option>
                            <option value="PHEV">PHEV</option>
                            <option value="Electric">Electric</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">MPG (Combined)</label>
                        <input type="number" id="manualMPG" placeholder="e.g. 30" onchange="calculateFuelCostFromMPG();" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                        <small style="opacity: 0.8; font-size: 11px;">For fuel cost calculation</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Depreciation %</label>
                        <input type="number" id="manualDepreciation" placeholder="Auto-calculated" min="5" max="70" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9);">
                        <small style="opacity: 0.8; font-size: 11px;">3-year % (auto-filled)</small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Reliability (1-10)</label>
                        <input type="number" id="manualReliability" placeholder="Auto-calculated" min="1" max="10" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Style Score (1-10)</label>
                        <input type="number" id="manualStyle" placeholder="Auto-calculated" min="1" max="10" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Annual Fuel Cost</label>
                        <input type="number" id="manualFuelCost" placeholder="Auto-calculated" min="200" max="5000" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Annual Maintenance</label>
                        <input type="number" id="manualMaintenance" placeholder="Auto-calculated" min="200" max="5000" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Annual Insurance</label>
                        <input type="number" id="manualInsurance" placeholder="Auto-calculated" min="200" max="3000" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.9);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Notes</label>
                        <input type="text" id="manualNotes" placeholder="Personal car, great condition" style="width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button id="addManualCarBtn" onclick="addManualCar()" style="background: #f39c12; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease; margin: 5px;">
                        ‚ûï Add Car to Analysis
                    </button>
                    <br>
                    <button onclick="exportManualCarsToCSV()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">
                        üì• Export My Cars
                    </button>
                    <button onclick="clearAllManualCars()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">
                        üóëÔ∏è Clear All Manual Cars
                    </button>
                    <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.8;">* Required fields. Other fields auto-calculated. Manual cars saved locally & persist between sessions.</p>
                </div>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Stats populated by JavaScript -->
        </div>
        
        <div class="color-toggle-container" style="text-align: center; margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
            <h3 style="margin: 0 0 15px 0; font-size: 1.2em;">üé® Chart Color Mode</h3>
            <label for="colorMode" style="font-weight: bold; margin-right: 15px; font-size: 1.1em;">Color all charts by:</label>
            <select id="colorMode" style="padding: 10px 15px; border-radius: 8px; border: none; font-size: 16px; background: white; color: #2c3e50; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <option value="fuel">‚õΩ Fuel Type (Electric/Hybrid/Gas)</option>
                <option value="brand">üè≠ Brand (Tesla/Honda/Toyota/etc)</option>
            </select>
            <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.9;">Toggle this to change colors across all charts!</p>
        </div>
        
        <div class="charts-grid">
            
            <div class="chart-container">
                <h3 class="chart-title">TCO vs Reliability (Click Points for Details)</h3>
                <div class="chart-canvas">
                    <canvas id="tcoReliabilityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Price vs Total Depreciation Loss</h3>
                <div class="chart-canvas">
                    <canvas id="depreciationChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">True TCO by Brand (With Depreciation)</h3>
                <div class="chart-canvas">
                    <canvas id="tcoBrandChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Fuel Type TCO Reality Check</h3>
                <div class="chart-canvas">
                    <canvas id="fuelTypeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Maintenance Cost vs Age</h3>
                <div class="chart-canvas">
                    <canvas id="maintenanceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Insurance Cost Analysis</h3>
                <div class="chart-canvas">
                    <canvas id="insuranceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">EV Depreciation Massacre</h3>
                <div class="chart-canvas">
                    <canvas id="evDepreciationChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Hidden Costs Breakdown</h3>
                <div class="chart-canvas">
                    <canvas id="hiddenCostsChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Best/Worst TCO by Category</h3>
                <div class="chart-canvas">
                    <canvas id="categoryTCOChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Reliability vs Maintenance Costs</h3>
                <div class="chart-canvas">
                    <canvas id="reliabilityMaintenanceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üé© Style/Credibility vs TCO</h3>
                <div class="chart-canvas">
                    <canvas id="styleTCOChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table" id="carDataTable">
                <thead>
                    <tr>
                        <th>Car</th>
                        <th>True TCO</th>
                        <th>Purchase Price</th>
                        <th>Depreciation Loss</th>
                        <th>Maintenance</th>
                        <th>Fuel</th>
                        <th>Insurance</th>
                        <th>Reliability</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="carTableBody">
                    <!-- Table populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal for car details -->
    <div id="carModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent">
                <!-- Modal content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Modern chart color palette optimized for dark theme
        const chartColors = {
            electric: '#ef4444',    // Red for EVs (high depreciation)
            hybrid: '#22c55e',      // Green for hybrids (best value)
            phev: '#3b82f6',        // Blue for PHEVs
            gas: '#f59e0b',         // Orange for gas cars
            luxury: '#8b5cf6',      // Purple for luxury
            sports: '#ec4899',      // Pink for sports cars
            reliable: '#10b981',    // Emerald for reliable brands
            unreliable: '#f87171',  // Light red for unreliable
            gradient: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe']
        };

        // Chart.js default configuration for dark theme
        Chart.defaults.color = '#f7fafc';
        Chart.defaults.borderColor = '#4a5568';
        Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(45, 55, 72, 0.95)';
        Chart.defaults.plugins.tooltip.titleColor = '#f7fafc';
        Chart.defaults.plugins.tooltip.bodyColor = '#e2e8f0';
        Chart.defaults.plugins.tooltip.borderColor = '#4a5568';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.scale.ticks.color = '#a0aec0';
        Chart.defaults.scale.title.color = '#e2e8f0';

        // Car data loaded dynamically from CSV and live prices
        let carData = [];
        let livePricesData = null;
        let lastUpdated = null;
        
        // Function to load live prices data
        async function loadLivePrices() {
            try {
                const response = await fetch('./live_prices.json');
                if (response.ok) {
                    livePricesData = await response.json();
                    lastUpdated = new Date(livePricesData.timestamp);
                    console.log(`Loaded live prices: ${livePricesData.total_cars} cars, updated ${lastUpdated.toLocaleString()}`);
                    updateLastUpdatedDisplay();
                    return true;
                }
            } catch (error) {
                console.log('Live prices not available, using static data:', error.message);
            }
            return false;
        }
        
        // Function to update last updated display
        function updateLastUpdatedDisplay() {
            const headerSubtitle = document.querySelector('.header-subtitle');
            if (headerSubtitle && lastUpdated) {
                const timeAgo = getTimeAgo(lastUpdated);
                headerSubtitle.innerHTML = `Real-time market data ‚Ä¢ Last updated: ${timeAgo} ‚Ä¢ ${livePricesData?.successful_scrapes || 0}/${livePricesData?.total_cars || 0} live sources`;
            }
        }
        
        // Function to get human readable time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }
        
        // Function to get live price data for a car
        function getLivePriceData(make, model) {
            if (!livePricesData) return null;
            
            return livePricesData.cars.find(car => 
                car.make.toLowerCase() === make.toLowerCase() && 
                car.model.toLowerCase() === model.toLowerCase()
            );
        }
        
        // Function to parse CSV and convert to our data structure
        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const cars = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const car = {};
                
                headers.forEach((header, index) => {
                    car[header.trim()] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                });
                
                // Convert to our dashboard format
                const dashboardCar = {
                    name: `${car.make} ${car.model}`,
                    make: car.make,
                    model: car.model,
                    year: car.year_range.includes('-') ? car.year_range.split('-')[1] : car.year_range,
                    price: Math.round((parseInt(car.price_range_low) + parseInt(car.price_range_high)) / 2),
                    depreciation: parseInt(car.depreciation_3yr_percent),
                    fuel: car.fuel_type,
                    brand: car.make,
                    category: car.category,
                    reliability: parseInt(car.reliability_score),
                    fuelCost: parseInt(car.annual_fuel_cost),
                    maintenanceCost: parseInt(car.maintenance_annual),
                    insuranceCost: parseInt(car.insurance_annual),
                    founderCredibility: parseInt(car.coolness_score),
                    notes: car.notes,
                    staticPrice: Math.round((parseInt(car.price_range_low) + parseInt(car.price_range_high)) / 2)
                };
                
                // Check for live price data and update if available
                const liveData = getLivePriceData(car.make, car.model);
                if (liveData && liveData.listings_count > 0) {
                    dashboardCar.price = liveData.current_price;
                    dashboardCar.livePriceData = {
                        current: liveData.current_price,
                        min: liveData.min_price,
                        max: liveData.max_price,
                        listings: liveData.listings_count,
                        sources: liveData.price_sources,
                        trend: liveData.price_trend || 'stable',
                        marketStatus: liveData.market_status || 'unknown',
                        isLive: true
                    };
                    dashboardCar.notes += ` | üî¥ LIVE: $${liveData.current_price.toLocaleString()} (${liveData.listings_count} listings)`;
                }
                
                // Calculate TCO: (price * depreciation%) + (annual costs * 3 years)
                dashboardCar.tco = Math.round(
                    dashboardCar.price * (dashboardCar.depreciation / 100) + 
                    (dashboardCar.fuelCost + dashboardCar.maintenanceCost + dashboardCar.insuranceCost) * 3
                );
                
                cars.push(dashboardCar);
            }
            
            // Add the user's personal Scion xB
            cars.push({
                name: 'Scion xB (2011) - Personal',
                make: 'Scion',
                model: 'xB',
                year: '2011',
                price: 2000,
                depreciation: 5,
                fuel: 'Gas',
                brand: 'Scion',
                category: 'Budget',
                reliability: 6,
                fuelCost: 3300,
                maintenanceCost: 2400,
                insuranceCost: 800,
                founderCredibility: 3,
                tco: 2000 * 0.05 + 3300 * 3 + 2400 * 3 + 800 * 3, // 19600
                notes: "Actual owned car: $2k shipping cost, 120k miles, battery issues - but unbeatable entry cost"
            });
            
            return cars;
        }
        
        // Load live prices first, then CSV data
        async function loadAllData() {
            // Try to load live prices first
            await loadLivePrices();
            
            // Then load CSV data
            try {
                const response = await fetch('./comprehensive_car_analysis.csv');
                const csvText = await response.text();
                carData = parseCSVData(csvText);
                console.log(`Loaded ${carData.length} cars from CSV`);
                
                // Load manual cars from local storage and add to dataset
                const manualCars = loadManualCarsFromStorage();
                if (manualCars.length > 0) {
                    carData.push(...manualCars);
                    console.log(`Added ${manualCars.length} manual cars from storage`);
                }
                
                // Count how many have live data
                const liveDataCount = carData.filter(car => car.livePriceData?.isLive).length;
                console.log(`${liveDataCount} cars have live pricing data`);
                
                initializeDashboard();
            } catch (error) {
                console.error('Error loading CSV:', error);
                // Fallback to basic data if CSV fails
                carData = [
                    {name: 'Tesla Model 3', price: 25500, depreciation: 45, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 8, 
                     fuelCost: 825, maintenanceCost: 900, insuranceCost: 1200, founderCredibility: 5,
                     tco: 25500 * 0.45 + 825 * 3 + 900 * 3 + 1200 * 3,
                     notes: "Fallback data - CSV failed to load"}
                ];
                initializeDashboard();
            }
        }
        
        // Start data loading
        loadAllData();
        
        // Refresh function for button
        async function refreshData() {
            const btn = document.getElementById('refreshDataBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Refreshing...';
            
            try {
                // Reload live prices
                await loadLivePrices();
                
                // Reload CSV data with new live prices
                const response = await fetch('./comprehensive_car_analysis.csv');
                const csvText = await response.text();
                carData = parseCSVData(csvText);
                
                // Count live data
                const liveDataCount = carData.filter(car => car.livePriceData?.isLive).length;
                console.log(`Refreshed: ${liveDataCount} cars have live pricing data`);
                
                // Update filters and dashboard
                filteredData = [...carData];
                populateBrandFilter();
                updateDashboard();
                
                btn.innerHTML = '‚úÖ Refreshed!';
                setTimeout(() => {
                    btn.innerHTML = 'üîÑ Refresh Live Prices';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Refresh failed:', error);
                btn.innerHTML = '‚ùå Failed';
                setTimeout(() => {
                    btn.innerHTML = 'üîÑ Refresh Live Prices';
                    btn.disabled = false;
                }, 2000);
            }
        }

        let filteredData = [];
        let charts = {};

        // Initialize dashboard after data is loaded
        function initializeDashboard() {
            filteredData = [...carData];
            performance.mark('init-start');
            
            populateBrandFilter();
            updateDashboard();
            setupEventListeners();
            enhanceAccessibility();
            monitorPerformance();
            
            performance.mark('init-end');
            performance.measure('Dashboard Initialization', 'init-start', 'init-end');
            
            // Add loading complete indicator
            document.body.classList.add('loaded');
            console.log('Dashboard initialized with CSV data');
        }

        // Populate brand filter
        function populateBrandFilter() {
            const brandFilter = document.getElementById('brandFilter');
            const brands = [...new Set(carData.map(car => car.brand))].sort();
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });
        }

        // Debounce function for performance
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Apply filters with performance optimization
        function applyFilters() {
            const budget = document.getElementById('budgetFilter').value;
            const fuel = document.getElementById('fuelFilter').value;
            const reliability = document.getElementById('reliabilityFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const year = document.getElementById('yearFilter').value;

            filteredData = carData.filter(car => {
                // Budget filter
                if (budget !== 'all') {
                    switch(budget) {
                        case 'under20k': if (car.price >= 20000) return false; break;
                        case '20to30k': if (car.price < 20000 || car.price >= 30000) return false; break;
                        case '30to40k': if (car.price < 30000 || car.price >= 40000) return false; break;
                        case '40to50k': if (car.price < 40000 || car.price >= 50000) return false; break;
                        case 'over50k': if (car.price < 50000) return false; break;
                    }
                }

                // Fuel filter
                if (fuel !== 'all' && car.fuel !== fuel) return false;

                // Reliability filter
                if (reliability !== 'all' && car.reliability < parseInt(reliability)) return false;

                // Brand filter
                if (brand !== 'all' && car.brand !== brand) return false;
                
                // Year filter
                if (year !== 'all') {
                    const carYear = parseInt(car.year);
                    switch(year) {
                        case '2024': if (carYear !== 2024) return false; break;
                        case '2023': if (carYear !== 2023) return false; break;
                        case '2022': if (carYear !== 2022) return false; break;
                        case '2021': if (carYear !== 2021) return false; break;
                        case '2020': if (carYear !== 2020) return false; break;
                        case '2019': if (carYear !== 2019) return false; break;
                        case '2018': if (carYear !== 2018) return false; break;
                        case '2017-2018': if (carYear < 2017 || carYear > 2018) return false; break;
                        case 'new': if (carYear < 2023 || carYear > 2024) return false; break;
                        case 'recent': if (carYear < 2021 || carYear > 2022) return false; break;
                        case 'older': if (carYear < 2018 || carYear > 2020) return false; break;
                    }
                }

                return true;
            });

            updateDashboard();
        }

        // Debounced version of applyFilters for performance
        const debouncedApplyFilters = debounce(applyFilters, 150);

        // Update statistics
        function updateStats() {
            const avgTCO = filteredData.reduce((sum, car) => sum + car.tco, 0) / filteredData.length;
            const avgDepreciation = filteredData.reduce((sum, car) => sum + (car.price * car.depreciation / 100), 0) / filteredData.length;
            const avgMaintenance = filteredData.reduce((sum, car) => sum + car.maintenanceCost, 0) / filteredData.length;
            const avgFuel = filteredData.reduce((sum, car) => sum + car.fuelCost, 0) / filteredData.length;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${filteredData.length}</div>
                    <div class="stat-label">Cars Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgTCO).toLocaleString()}</div>
                    <div class="stat-label">Average True TCO</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgDepreciation).toLocaleString()}</div>
                    <div class="stat-label">Average Depreciation Hit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgMaintenance).toLocaleString()}</div>
                    <div class="stat-label">Average Annual Maintenance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgFuel).toLocaleString()}</div>
                    <div class="stat-label">Average Annual Fuel Cost</div>
                </div>
            `;
        }

        // Show car details modal with accessibility
        function showCarDetails(car) {
            performance.mark('modal-open-start');
            const depreciationLoss = car.price * car.depreciation / 100;
            const totalFuelCost = car.fuelCost * 3;
            const totalMaintenanceCost = car.maintenanceCost * 3;
            const totalInsuranceCost = car.insuranceCost * 3;

            const modalContent = `
                <h2>${car.name} - Complete TCO Breakdown</h2>
                
                <div class="warning">
                    <div class="warning-title">‚ö†Ô∏è TCO Reality Check</div>
                    ${car.notes}
                </div>
                
                <div class="car-detail-grid">
                    <div class="detail-card">
                        <div class="detail-title">üí∞ Total Cost of Ownership (3 Years)</div>
                        <div class="detail-value">$${car.tco.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            All costs included over 3 years
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üìâ Depreciation Hit</div>
                        <div class="detail-value">$${depreciationLoss.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            ${car.depreciation}% of $${car.price.toLocaleString()} purchase price<br>
                            This is money you'll never get back
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">‚õΩ Fuel Costs (3 Years)</div>
                        <div class="detail-value">$${totalFuelCost.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            $${car.fuelCost.toLocaleString()}/year √ó 3 years<br>
                            Based on 210 miles/week commute
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üîß Maintenance (3 Years)</div>
                        <div class="detail-value">$${totalMaintenanceCost.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            $${car.maintenanceCost.toLocaleString()}/year √ó 3 years<br>
                            Includes repairs, service, parts
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üõ°Ô∏è Insurance (3 Years)</div>
                        <div class="detail-value">$${totalInsuranceCost.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            $${car.insuranceCost.toLocaleString()}/year √ó 3 years<br>
                            Based on SF rates for ${car.category}
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">‚≠ê Reliability Score</div>
                        <div class="detail-value">${car.reliability}/10</div>
                        <div class="detail-breakdown">
                            Based on long-term owner surveys<br>
                            Higher = fewer surprise repairs
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üìä Cost Breakdown</div>
                        <div class="detail-value">
                            Depreciation: ${Math.round(depreciationLoss/car.tco*100)}%<br>
                            Fuel: ${Math.round(totalFuelCost/car.tco*100)}%<br>
                            Maintenance: ${Math.round(totalMaintenanceCost/car.tco*100)}%<br>
                            Insurance: ${Math.round(totalInsuranceCost/car.tco*100)}%
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üí° Bottom Line</div>
                        <div class="detail-value">
                            ${car.tco < 20000 ? "üü¢ Great Value" : 
                              car.tco < 25000 ? "üü° Decent Value" :
                              car.tco < 30000 ? "üü† Expensive" : "üî¥ Very Expensive"}
                        </div>
                        <div class="detail-breakdown">
                            Monthly cost: $${Math.round(car.tco/36).toLocaleString()}<br>
                            Daily cost: $${Math.round(car.tco/1095).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            const modal = document.getElementById('carModal');
            modal.style.display = 'block';
            
            // Focus management for accessibility
            modal.setAttribute('aria-hidden', 'false');
            const closeButton = modal.querySelector('.close');
            closeButton.focus();
            
            // Trap focus within modal
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            lastFocusable.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            firstFocusable.focus();
                            e.preventDefault();
                        }
                    }
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            performance.mark('modal-open-end');
            performance.measure('Modal Open', 'modal-open-start', 'modal-open-end');
        }
        
        // Close modal function
        function closeModal() {
            const modal = document.getElementById('carModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            // Return focus to triggering element if possible
            document.querySelector('.data-table tr[tabindex="0"]')?.focus();
        }

        // Create table
        function updateTable() {
            const tbody = document.getElementById('carTableBody');
            const sortedData = [...filteredData].sort((a, b) => a.tco - b.tco);
            
            tbody.innerHTML = sortedData.map((car, index) => {
                const rankBadge = index < 5 ? '‚õΩ' : index < 10 ? 'ü•à' : index < 20 ? 'ü•â' : '';
                const tcoColor = car.tco < 20000 ? 'color: var(--accent-green)' : 
                                car.tco < 25000 ? 'color: var(--text-primary)' : 
                                car.tco < 30000 ? 'color: var(--accent-orange)' : 'color: var(--accent-red)';
                
                return `
                    <tr onclick="showCarDetails(${JSON.stringify(car).replace(/"/g, '&quot;')})" 
                        role="button" tabindex="0" 
                        onkeypress="if(event.key==='Enter')showCarDetails(${JSON.stringify(car).replace(/"/g, '&quot;')})" 
                        aria-label="View details for ${car.name}">
                        <td><strong>${rankBadge} ${car.name}</strong></td>
                        <td><strong style="${tcoColor}">$${car.tco.toLocaleString()}</strong></td>
                        <td>$${car.price.toLocaleString()}</td>
                        <td>$${Math.round(car.price * car.depreciation / 100).toLocaleString()}</td>
                        <td>$${car.maintenanceCost.toLocaleString()}/yr</td>
                        <td>$${car.fuelCost.toLocaleString()}/yr</td>
                        <td>$${car.insuranceCost.toLocaleString()}/yr</td>
                        <td>${car.reliability}/10 ${'‚≠ê'.repeat(Math.floor(car.reliability / 2))}</td>
                        <td><span style="font-size: 0.8rem; color: var(--text-secondary)">üëÜ Details</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Chart creation functions with click handlers
        function createNewUsedChart() {
            const ctx = document.getElementById('newUsedChart').getContext('2d');
            if (charts.newUsed) charts.newUsed.destroy();
            
            // Sample data showing new vs used TCO differences for popular cars
            const comparisonData = [
                {car: 'Tesla Model 3', newTCO: 64761, usedTCO: 45750, savings: 19011},
                {car: 'Honda Civic', newTCO: 44450, usedTCO: 32760, savings: 11690},
                {car: 'BMW i4', newTCO: 83005, usedTCO: 62525, savings: 20480},
                {car: 'Toyota RAV4 Hybrid', newTCO: 52000, usedTCO: 38400, savings: 13600},
                {car: 'Genesis G70', newTCO: 48500, usedTCO: 35200, savings: 13300},
                {car: 'Hyundai Ioniq 5', newTCO: 58000, usedTCO: 39600, savings: 18400},
                {car: 'Lexus ES Hybrid', newTCO: 55000, usedTCO: 41200, savings: 13800},
                {car: 'Audi A4', newTCO: 51200, usedTCO: 38900, savings: 12300}
            ];
            
            charts.newUsed = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: comparisonData.map(d => d.car),
                    datasets: [
                        {
                            label: 'NEW Car 3-Year TCO',
                            data: comparisonData.map(d => d.newTCO),
                            backgroundColor: filteredData.filter(car => car.fuel === 'Electric').map(car => getCarColor(car)),
                            borderColor: '#dc2626',
                            borderWidth: 2,
                            borderRadius: 4
                        },
                        {
                            label: 'USED Car 3-Year TCO',
                            data: comparisonData.map(d => d.usedTCO),
                            backgroundColor: filteredData.filter(car => car.fuel === 'Hybrid' || car.fuel === 'PHEV').map(car => getCarColor(car)),
                            borderColor: '#16a34a',
                            borderWidth: 2,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const savings = comparisonData[dataIndex].savings;
                                    return [`üí∞ Save $${savings.toLocaleString()} buying used!`];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Car Models' },
                            ticks: { maxRotation: 45 }
                        },
                        y: {
                            title: { display: true, text: '3-Year TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createTCOReliabilityChart() {
            const ctx = document.getElementById('tcoReliabilityChart').getContext('2d');
            if (charts.tcoReliability) charts.tcoReliability.destroy();
            
            charts.tcoReliability = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map((car, index) => ({
                            x: car.reliability,
                            y: car.tco,
                            label: car.name,
                            carIndex: index
                        })),
                        backgroundColor: filteredData.map(car => getCarColor(car)),
                        pointRadius: 10,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            showCarDetails(filteredData[dataIndex]);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.tco.toLocaleString()} TCO, ${car.reliability}/10 reliability (Click for details)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Reliability Score (1-10)' },
                            min: 4, max: 10
                        },
                        y: {
                            title: { display: true, text: 'True 3-Year TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDepreciationChart() {
            const ctx = document.getElementById('depreciationChart').getContext('2d');
            if (charts.depreciation) charts.depreciation.destroy();
            
            charts.depreciation = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: car.price,
                            y: car.price * car.depreciation / 100,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => getCarColor(car)),
                        pointRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.price.toLocaleString()} ‚Üí loses $${Math.round(car.price * car.depreciation / 100).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Purchase Price ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'Total Depreciation Loss ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createFuelTypeChart() {
            const ctx = document.getElementById('fuelTypeChart').getContext('2d');
            if (charts.fuelType) charts.fuelType.destroy();
            
            const fuelData = {};
            filteredData.forEach(car => {
                if (!fuelData[car.fuel]) {
                    fuelData[car.fuel] = [];
                }
                fuelData[car.fuel].push(car.tco);
            });

            const fuelTypes = Object.keys(fuelData).map(fuel => ({
                fuel: fuel,
                avgTCO: fuelData[fuel].reduce((sum, tco) => sum + tco, 0) / fuelData[fuel].length,
                count: fuelData[fuel].length
            }));

            charts.fuelType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fuelTypes.map(f => `${f.fuel}\\n($${Math.round(f.avgTCO/1000)}k avg)`),
                    datasets: [{
                        label: 'Average TCO by Fuel Type',
                        data: fuelTypes.map(f => f.avgTCO),
                        backgroundColor: fuelTypes.map(f => {
                            switch(f.fuel) {
                                case 'Electric': return '#e74c3c'; // Red - highest TCO due to depreciation
                                case 'Hybrid': return '#2ecc71'; // Green - best TCO
                                case 'PHEV': return '#3498db'; // Blue - middle
                                case 'Gas': return '#f39c12'; // Orange - middle-high
                                default: return '#95a5a6';
                            }
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const fuel = fuelTypes[context.dataIndex];
                                    return `${fuel.fuel}: $${context.parsed.y.toLocaleString()} avg TCO (${fuel.count} cars)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Average True TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMaintenanceChart() {
            const ctx = document.getElementById('maintenanceChart').getContext('2d');
            if (charts.maintenance) charts.maintenance.destroy();
            
            charts.maintenance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: 2024 - Math.floor(Math.random() * 5 + 2019), // Approximate age
                            y: car.maintenanceCost,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => {
                            return getCarColor(car);
                        }),
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.maintenanceCost.toLocaleString()}/year maintenance`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Vehicle Age (Years)' } },
                        y: { 
                            title: { display: true, text: 'Annual Maintenance Cost ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createInsuranceChart() {
            const ctx = document.getElementById('insuranceChart').getContext('2d');
            if (charts.insurance) charts.insurance.destroy();
            
            charts.insurance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: car.price,
                            y: car.insuranceCost,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => getCarColor(car)),
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.insuranceCost.toLocaleString()}/year insurance`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Vehicle Price ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        y: { 
                            title: { display: true, text: 'Annual Insurance Cost ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createEVDepreciationChart() {
            const ctx = document.getElementById('evDepreciationChart').getContext('2d');
            if (charts.evDepreciation) charts.evDepreciation.destroy();
            
            const evData = filteredData.filter(car => car.fuel === 'Electric');
            const gasData = filteredData.filter(car => car.fuel === 'Gas');
            const hybridData = filteredData.filter(car => car.fuel === 'Hybrid' || car.fuel === 'PHEV');
            
            charts.evDepreciation = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: evData.map(car => car.name.replace(' ', '\\n')),
                    datasets: [{
                        label: 'EV Depreciation %',
                        data: evData.map(car => car.depreciation),
                        backgroundColor: evData.map(car => getCarColor(car)),
                        borderColor: evData.map(car => getCarColor(car)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = evData[context.dataIndex];
                                    const loss = car.price * car.depreciation / 100;
                                    return `${car.name}: ${car.depreciation}% = $${loss.toLocaleString()} loss`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            title: { display: true, text: 'Depreciation Percentage (%)' },
                            ticks: { callback: function(value) { return value + '%'; } }
                        }
                    }
                }
            });
        }

        function createHiddenCostsChart() {
            const ctx = document.getElementById('hiddenCostsChart').getContext('2d');
            if (charts.hiddenCosts) charts.hiddenCosts.destroy();
            
            const sampleCars = filteredData.slice(0, 8);
            
            charts.hiddenCosts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sampleCars.map(car => car.name.replace(' ', '\\n')),
                    datasets: [
                        {
                            label: 'Depreciation',
                            data: sampleCars.map(car => car.price * car.depreciation / 100),
                            backgroundColor: '#e74c3c', // Keep cost categories consistent
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Fuel (3yr)',
                            data: sampleCars.map(car => car.fuelCost * 3),
                            backgroundColor: '#f39c12', // Keep cost categories consistent
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Maintenance (3yr)',
                            data: sampleCars.map(car => car.maintenanceCost * 3),
                            backgroundColor: '#3498db', // Keep cost categories consistent
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Insurance (3yr)',
                            data: sampleCars.map(car => car.insuranceCost * 3),
                            backgroundColor: '#9b59b6', // Keep cost categories consistent
                            stack: 'Stack 0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Cost ($)' },
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        x: { stacked: true }
                    }
                }
            });
        }

        function createCategoryTCOChart() {
            const ctx = document.getElementById('categoryTCOChart').getContext('2d');
            if (charts.categoryTCO) charts.categoryTCO.destroy();
            
            const categories = {};
            filteredData.forEach(car => {
                if (!categories[car.category]) {
                    categories[car.category] = [];
                }
                categories[car.category].push(car.tco);
            });

            const categoryData = Object.keys(categories).map(cat => ({
                category: cat,
                avgTCO: categories[cat].reduce((sum, tco) => sum + tco, 0) / categories[cat].length,
                minTCO: Math.min(...categories[cat]),
                maxTCO: Math.max(...categories[cat]),
                count: categories[cat].length
            })).sort((a, b) => a.avgTCO - b.avgTCO);

            charts.categoryTCO = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryData.map(c => `${c.category}\\n(${c.count} cars)`),
                    datasets: [{
                        label: 'Average TCO',
                        data: categoryData.map(c => c.avgTCO),
                        backgroundColor: categoryData.map(c => {
                            if (c.avgTCO < 20000) return '#2ecc71';
                            if (c.avgTCO < 25000) return '#f39c12';
                            if (c.avgTCO < 30000) return '#e67e22';
                            return '#e74c3c';
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const cat = categoryData[context.dataIndex];
                                    return `${cat.category}: $${context.parsed.y.toLocaleString()} avg TCO`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Average TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTCOBrandChart() {
            const ctx = document.getElementById('tcoBrandChart').getContext('2d');
            if (charts.tcoBrand) charts.tcoBrand.destroy();
            
            const brands = {};
            filteredData.forEach(car => {
                if (!brands[car.brand]) {
                    brands[car.brand] = [];
                }
                brands[car.brand].push(car.tco);
            });

            const brandData = Object.keys(brands).map(brand => ({
                brand: brand,
                avgTCO: brands[brand].reduce((sum, tco) => sum + tco, 0) / brands[brand].length,
                minTCO: Math.min(...brands[brand]),
                maxTCO: Math.max(...brands[brand]),
                count: brands[brand].length
            })).sort((a, b) => a.avgTCO - b.avgTCO);

            charts.tcoBrand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brandData.map(b => `${b.brand}\n(${b.count} cars)`),
                    datasets: [{
                        label: 'Average TCO',
                        data: brandData.map(b => b.avgTCO),
                        backgroundColor: brandData.map(b => {
                            // Color coding by average TCO range
                            if (b.avgTCO < 18000) return '#2ecc71'; // Green - Great value
                            if (b.avgTCO < 25000) return '#27ae60'; // Dark green - Good value  
                            if (b.avgTCO < 30000) return '#f39c12'; // Orange - Moderate
                            if (b.avgTCO < 35000) return '#e67e22'; // Dark orange - Expensive
                            return '#e74c3c'; // Red - Very expensive
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const brand = brandData[context.dataIndex];
                                    return `${brand.brand}: $${context.parsed.y.toLocaleString()} avg TCO (${brand.count} models)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Average TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        x: {
                            ticks: { maxRotation: 45 }
                        }
                    }
                }
            });
        }

        // Function to create all charts
        function createAllCharts() {
            console.log('Creating all charts...');
            createTCOReliabilityChart();
            createDepreciationChart();
            createTCOBrandChart(); // New brand chart
            createFuelTypeChart();
            createMaintenanceChart();
            createInsuranceChart();
            createEVDepreciationChart();
            createHiddenCostsChart();
            createCategoryTCOChart();
            createReliabilityMaintenanceChart();
            createStyleTCOChart();
            console.log('All charts created successfully');
        }

        function createReliabilityMaintenanceChart() {
            const ctx = document.getElementById('reliabilityMaintenanceChart').getContext('2d');
            if (charts.reliabilityMaintenance) charts.reliabilityMaintenance.destroy();
            
            charts.reliabilityMaintenance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: car.reliability,
                            y: car.maintenanceCost,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => {
                            return getCarColor(car);
                        }),
                        pointRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: ${car.reliability}/10 reliability, $${car.maintenanceCost.toLocaleString()}/yr maintenance`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Reliability Score (1-10)' } },
                        y: { 
                            title: { display: true, text: 'Annual Maintenance Cost ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStyleTCOChart() {
            const ctx = document.getElementById('styleTCOChart').getContext('2d');
            if (charts.styleTCO) charts.styleTCO.destroy();
            
            // Add default founder credibility scores for cars missing them
            const styledCars = filteredData.map(car => {
                if (car.founderCredibility) return car;
                
                // Assign default credibility based on brand/category
                let defaultCredibility = 4; // Default baseline
                
                if (car.brand === 'Tesla') defaultCredibility = 6;
                else if (car.brand === 'Porsche') defaultCredibility = 10;
                else if (car.brand === 'BMW') defaultCredibility = 8;
                else if (car.brand === 'Mercedes') defaultCredibility = 8;
                else if (car.brand === 'Audi') defaultCredibility = 7;
                else if (car.brand === 'Lexus') defaultCredibility = 6;
                else if (car.brand === 'Genesis') defaultCredibility = 7;
                else if (car.brand === 'Range Rover') defaultCredibility = 9;
                else if (car.brand === 'Honda' && car.name.includes('Type R')) defaultCredibility = 7;
                else if (car.brand === 'Honda') defaultCredibility = 4;
                else if (car.brand === 'Toyota' && car.name.includes('RAV4')) defaultCredibility = 6;
                else if (car.brand === 'Toyota') defaultCredibility = 4;
                else if (car.brand === 'Chevrolet') defaultCredibility = 3;
                else if (car.brand === 'Nissan') defaultCredibility = 3;
                else if (car.brand === 'Hyundai' || car.brand === 'Kia') defaultCredibility = 4;
                else if (car.brand === 'Ford') defaultCredibility = 5;
                else if (car.brand === 'Scion') defaultCredibility = 3;
                
                return {...car, founderCredibility: defaultCredibility};
            });
            
            charts.styleTCO = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: styledCars.map(car => ({
                            x: car.founderCredibility,
                            y: car.tco,
                            label: car.name,
                            car: car
                        })),
                        backgroundColor: styledCars.map(car => getCarColor(car)),
                        pointRadius: 10,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const car = styledCars[dataIndex];
                            showCarModal(car);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = styledCars[context.dataIndex];
                                    return `${car.name}: Style ${car.founderCredibility}/10, TCO $${car.tco.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Fuel Efficiency/Style Score (1-10)' },
                            min: 0, max: 10
                        },
                        y: {
                            title: { display: true, text: '3-Year TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Color toggle functionality
        function getCarColor(car, mode) {
            if (!mode) {
                mode = document.getElementById('colorMode') ? document.getElementById('colorMode').value : 'fuel';
            }
            
            if (mode === 'brand') {
                const brandColors = {
                    'Tesla': '#e74c3c',
                    'Honda': '#27ae60', 
                    'Toyota': '#f39c12',
                    'BMW': '#3498db',
                    'Mercedes': '#9b59b6',
                    'Audi': '#e67e22',
                    'Genesis': '#34495e',
                    'Lexus': '#1abc9c',
                    'Porsche': '#f1c40f',
                    'Chevrolet': '#c0392b',
                    'Hyundai': '#8e44ad',
                    'Kia': '#16a085',
                    'Nissan': '#2980b9',
                    'Volkswagen': '#95a5a6',
                    'Ford': '#d35400',
                    'Polestar': '#7f8c8d',
                    'Scion': '#2ecc71',
                    'Range Rover': '#8e44ad',
                    'Acura': '#3498db',
                    'Infiniti': '#e67e22',
                    'Lincoln': '#34495e',
                    'Mazda': '#e74c3c',
                    'Subaru': '#16a085',
                    'Volvo': '#95a5a6',
                    'Alfa Romeo': '#c0392b',
                    'Mini': '#f39c12',
                    'Cadillac': '#9b59b6'
                };
                return brandColors[car.brand] || '#bdc3c7';
            } else {
                // Fuel type colors
                if (car.fuel === 'Electric') return '#e74c3c';
                if (car.fuel === 'Hybrid' || car.fuel === 'PHEV') return '#27ae60';
                return '#3498db';
            }
        }

        // Optimized dashboard update with loading state
        function updateDashboard() {
            // Show loading state
            const containers = document.querySelectorAll('.chart-container, .stats-grid, .table-container');
            containers.forEach(container => {
                container.style.opacity = '0.6';
                container.style.pointerEvents = 'none';
            });

            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                // Destroy charts efficiently
                Object.values(charts).forEach(chart => {
                    if (chart && chart.destroy) chart.destroy();
                });
                charts = {};

                updateStats();
                updateTable();
                
                // Create charts with slight delay for better UX
                setTimeout(() => {
                    createAllCharts();
                    
                    // Remove loading state
                    containers.forEach(container => {
                        container.style.opacity = '1';
                        container.style.pointerEvents = 'auto';
                    });
                }, 100);
            });
        }

        // Manual car entry function
        // Toggle manual entry form
        function toggleManualEntryForm() {
            const form = document.getElementById('manualEntryForm');
            const button = document.getElementById('toggleManualEntry');
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                button.textContent = 'üöó Hide Car Entry Form';
                populateBrandDropdown();
            } else {
                form.style.display = 'none';
                button.textContent = 'üöó Add Custom Car (Click to Open)';
            }
        }
        
        // Populate brand dropdown with existing brands + "Add new" option
        function populateBrandDropdown() {
            const brandSelect = document.getElementById('manualBrand');
            const existingBrands = [...new Set(carData.map(car => car.brand || car.make))].sort();
            
            brandSelect.innerHTML = '<option value="">Select Brand...</option>';
            existingBrands.forEach(brand => {
                if (brand) {
                    brandSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
                }
            });
            brandSelect.innerHTML += '<option value="__NEW__">‚ûï Add New Brand</option>';
        }
        
        // Handle brand dropdown change
        function updateBrandField() {
            const brandSelect = document.getElementById('manualBrand');
            const customInput = document.getElementById('manualBrandCustom');
            
            if (brandSelect.value === '__NEW__') {
                brandSelect.style.display = 'none';
                customInput.style.display = 'block';
                customInput.focus();
            }
        }
        
        // Auto-calculate values based on brand and fuel type patterns
        function autoCalculateValues() {
            const brand = document.getElementById('manualBrand').value || document.getElementById('manualBrandCustom').value;
            const price = document.getElementById('manualPrice').value;
            const fuel = document.getElementById('manualFuel').value;
            const year = document.getElementById('manualYear').value;
            
            if (brand && fuel) {
                document.getElementById('manualDepreciation').value = getDefaultDepreciation(fuel, brand, parseInt(year));
                document.getElementById('manualReliability').value = getDefaultReliability(brand);
                document.getElementById('manualStyle').value = getDefaultStyle(brand, '');
                document.getElementById('manualMaintenance').value = getDefaultMaintenance(brand, fuel);
                document.getElementById('manualInsurance').value = getDefaultInsurance(parseInt(price) || 25000);
                
                if (!document.getElementById('manualMPG').value) {
                    document.getElementById('manualFuelCost').value = getDefaultFuelCost(fuel);
                }
            }
        }
        
        // Calculate fuel cost from MPG
        function calculateFuelCostFromMPG() {
            const mpg = document.getElementById('manualMPG').value;
            const fuel = document.getElementById('manualFuel').value;
            
            if (mpg && fuel && mpg > 0) {
                let fuelCost;
                const milesPerYear = 12000;
                const gasPrice = 3.50; // National average
                const electricRate = 0.13; // per kWh
                const kWhPer100Miles = 28; // EV efficiency
                
                if (fuel === 'Electric') {
                    // Electric: kWh cost (MPGe to actual cost)
                    fuelCost = Math.round((milesPerYear * kWhPer100Miles / 100) * electricRate);
                } else {
                    // Gas/Hybrid: gallons cost
                    fuelCost = Math.round((milesPerYear / mpg) * gasPrice);
                }
                
                document.getElementById('manualFuelCost').value = fuelCost;
            }
        }

        function addManualCar() {
            // Get required fields
            const brand = document.getElementById('manualBrand').value.trim();
            const model = document.getElementById('manualModel').value.trim();
            const year = document.getElementById('manualYear').value;
            const price = document.getElementById('manualPrice').value;
            const fuel = document.getElementById('manualFuel').value;

            // Validate required fields
            if (!brand || !model || !year || !price || !fuel) {
                alert('Please fill in all required fields (Brand, Model, Year, Price, Fuel Type)');
                return;
            }

            // Get optional fields with smart defaults
            const depreciation = document.getElementById('manualDepreciation').value || getDefaultDepreciation(fuel, brand, parseInt(year));
            const reliability = document.getElementById('manualReliability').value || getDefaultReliability(brand);
            const founderCredibility = document.getElementById('manualStyle').value || getDefaultStyle(brand, model);
            const fuelCost = document.getElementById('manualFuelCost').value || getDefaultFuelCost(fuel);
            const maintenanceCost = document.getElementById('manualMaintenance').value || getDefaultMaintenance(brand, fuel);
            const insuranceCost = document.getElementById('manualInsurance').value || getDefaultInsurance(parseInt(price));
            const notes = document.getElementById('manualNotes').value || 'Manually added car';

            // Create car object
            const newCar = {
                name: `${brand} ${model} (${year})`,
                make: brand,
                model: model,
                year: year,
                price: parseInt(price),
                depreciation: parseInt(depreciation),
                fuel: fuel,
                brand: brand,
                category: getDefaultCategory(fuel, model),
                reliability: parseInt(reliability),
                fuelCost: parseInt(fuelCost),
                maintenanceCost: parseInt(maintenanceCost),
                insuranceCost: parseInt(insuranceCost),
                founderCredibility: parseInt(founderCredibility),
                notes: `${notes} | üë§ USER ADDED`,
                isManual: true
            };

            // Calculate TCO
            newCar.tco = Math.round(
                newCar.price * (newCar.depreciation / 100) + 
                (newCar.fuelCost + newCar.maintenanceCost + newCar.insuranceCost) * 3
            );

            // Check for duplicates and handle numbering  
            const carName = `${newCar.make} ${newCar.model}`;
            const existingCars = carData.filter(car => 
                (car.name && car.name.startsWith(carName)) || 
                (car.make === newCar.make && car.model === newCar.model)
            );
            
            if (existingCars.length > 0) {
                const duplicateNumber = existingCars.length + 1;
                newCar.name = `${carName} #${duplicateNumber} (${newCar.year})`;
            }

            // Add to carData array
            carData.push(newCar);
            filteredData = [...carData];
            
            // Save to local storage for persistence
            saveManualCarsToStorage();

            // Update filters and dashboard
            populateBrandFilter();
            updateDashboard();

            // Clear form and show success
            clearManualForm();
            showSuccessMessage(newCar);

            console.log('Added manual car:', newCar);
        }

        // Local Storage Functions for Persistence
        function saveManualCarsToStorage() {
            const manualCars = carData.filter(car => car.isManual);
            try {
                localStorage.setItem('carDashboard_manualCars', JSON.stringify(manualCars));
                console.log(`Saved ${manualCars.length} manual cars to storage`);
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
            }
        }
        
        function loadManualCarsFromStorage() {
            try {
                const saved = localStorage.getItem('carDashboard_manualCars');
                if (saved) {
                    const manualCars = JSON.parse(saved);
                    console.log(`Loaded ${manualCars.length} manual cars from storage`);
                    return manualCars;
                }
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
            return [];
        }
        
        function exportManualCarsToCSV() {
            const manualCars = carData.filter(car => car.isManual);
            if (manualCars.length === 0) {
                alert('No manual cars to export!');
                return;
            }
            
            // CSV headers matching the main CSV format
            const headers = 'make,model,year,price,fuel_type,depreciation_3yr_percent,reliability_score,coolness_score,annual_fuel_cost,maintenance_annual,insurance_annual,notes';
            
            const csvRows = manualCars.map(car => 
                `${car.make},${car.model},${car.year},${car.price},${car.fuel},${car.depreciation},${car.reliability},${car.founderCredibility},${car.fuelCost},${car.maintenanceCost},${car.insuranceCost},"${car.notes}"`
            );
            
            const csvContent = [headers, ...csvRows].join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my_custom_cars_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${manualCars.length} custom cars to CSV file!`);
        }
        
        function clearAllManualCars() {
            if (confirm('Are you sure you want to remove all manually added cars? This cannot be undone.')) {
                carData = carData.filter(car => !car.isManual);
                filteredData = [...carData];
                localStorage.removeItem('carDashboard_manualCars');
                updateDashboard();
                alert('All manual cars have been removed.');
            }
        }

        // Helper functions for smart defaults
        function getDefaultDepreciation(fuel, brand, year) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            
            let base = 30; // Default 30%
            if (fuel === 'Electric') base = 45; // EVs depreciate more
            if (fuel === 'Hybrid') base = 25; // Hybrids hold value better
            if (brand === 'Toyota' || brand === 'Honda') base -= 5; // Reliable brands
            if (brand === 'Porsche') base -= 10; // Porsche holds value
            if (age > 3) base += 10; // Older cars
            
            return Math.max(15, Math.min(60, base));
        }

        function getDefaultReliability(brand) {
            const reliabilityMap = {
                'Toyota': 9, 'Honda': 9, 'Lexus': 9, 'Porsche': 9,
                'BMW': 7, 'Mercedes': 6, 'Audi': 7, 'Genesis': 8,
                'Tesla': 8, 'Mazda': 8, 'Subaru': 9,
                'Ford': 6, 'Chevrolet': 6, 'Nissan': 6
            };
            return reliabilityMap[brand] || 7;
        }

        function getDefaultStyle(brand, model) {
            // Brand-based style scores
            const brandStyle = {
                'Porsche': 10, 'BMW': 8, 'Mercedes': 8, 'Audi': 8,
                'Tesla': 6, 'Genesis': 7, 'Lexus': 7, 'Acura': 6,
                'Toyota': 5, 'Honda': 5, 'Mazda': 6, 'Subaru': 4,
                'Ford': 5, 'Chevrolet': 5, 'Nissan': 4
            };
            
            let score = brandStyle[brand] || 5;
            
            // Model-based adjustments
            if (model.toLowerCase().includes('m2') || model.toLowerCase().includes('m3') || model.toLowerCase().includes('m4')) score = 9;
            if (model.toLowerCase().includes('911') || model.toLowerCase().includes('cayman')) score = 10;
            if (model.toLowerCase().includes('prius')) score = 3;
            if (model.toLowerCase().includes('wrangler')) score = 9;
            if (model.toLowerCase().includes('corvette')) score = 9;
            
            return score;
        }

        function getDefaultFuelCost(fuel) {
            const fuelCosts = {
                'Electric': 825,
                'Hybrid': 1200,
                'PHEV': 900,
                'Gas': 1800
            };
            return fuelCosts[fuel] || 1800;
        }

        function getDefaultMaintenance(brand, fuel) {
            let base = 800;
            if (fuel === 'Electric') base = 600; // EVs need less maintenance
            if (brand === 'BMW' || brand === 'Mercedes' || brand === 'Audi') base = 1500; // German luxury
            if (brand === 'Porsche') base = 2000; // Performance cars
            if (brand === 'Toyota' || brand === 'Honda') base = 600; // Reliable brands
            return base;
        }

        function getDefaultInsurance(price) {
            // Rough estimate: 3-5% of car value annually
            return Math.round(price * 0.04);
        }

        function getDefaultCategory(fuel, model) {
            if (fuel === 'Electric') return 'Electric';
            if (fuel === 'Hybrid' || fuel === 'PHEV') return 'Hybrid';
            if (model.toLowerCase().includes('suv') || model.toLowerCase().includes('x3') || model.toLowerCase().includes('rav4')) return 'SUV';
            if (model.toLowerCase().includes('truck') || model.toLowerCase().includes('f-150')) return 'Truck';
            return 'Sedan';
        }

        function clearManualForm() {
            const fields = ['manualBrand', 'manualModel', 'manualYear', 'manualPrice', 'manualFuel', 
                          'manualDepreciation', 'manualReliability', 'manualStyle', 'manualFuelCost', 
                          'manualMaintenance', 'manualInsurance', 'manualNotes'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
        }

        function showSuccessMessage(car) {
            const btn = document.getElementById('addManualCarBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Added Successfully!';
            btn.style.background = '#27ae60';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '#f39c12';
            }, 3000);
            
            // Show a brief popup with the car's TCO
            alert(`‚úÖ Successfully added ${car.name}!\n\nüí∞ Calculated 3-Year TCO: $${car.tco.toLocaleString()}\nüìä Now visible in all charts!`);
        }

        // Setup event listeners with performance optimization
        function setupEventListeners() {
            // Use debounced filters for better performance
            document.getElementById('budgetFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('fuelFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('reliabilityFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('brandFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('yearFilter').addEventListener('change', debouncedApplyFilters);
            
            // Color toggle event listener
            document.getElementById('colorMode').addEventListener('change', updateDashboard);

            // Add loading states
            [document.getElementById('budgetFilter'), document.getElementById('fuelFilter'), 
             document.getElementById('reliabilityFilter'), document.getElementById('brandFilter'), 
             document.getElementById('yearFilter')].forEach(filter => {
                filter.addEventListener('change', () => {
                    document.body.classList.add('loading');
                    setTimeout(() => document.body.classList.remove('loading'), 500);
                });
            });

            // Modal close with accessibility
            document.querySelector('.close').onclick = closeModal;
            document.querySelector('.close').onkeypress = function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    closeModal();
                }
            };
            
            window.onclick = function(event) {
                if (event.target === document.getElementById('carModal')) {
                    closeModal();
                }
            };
        }

        // Accessibility improvements
        function enhanceAccessibility() {
            // Add ARIA labels and roles
            document.querySelectorAll('.stat-card').forEach((card, index) => {
                card.setAttribute('role', 'article');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Statistics card ${index + 1}`);
            });

            document.querySelectorAll('.chart-container').forEach((container, index) => {
                container.setAttribute('role', 'img');
                const title = container.querySelector('.chart-title').textContent;
                container.setAttribute('aria-label', `Chart: ${title}`);
            });

            // Keyboard navigation for table
            document.addEventListener('keydown', (e) => {
                if (e.target.closest('.data-table') && e.key === 'Enter') {
                    e.target.click();
                }
            });
        }

        // Performance monitoring
        function monitorPerformance() {
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.entryType === 'measure' && entry.duration > 100) {
                            console.warn(`Slow operation detected: ${entry.name} took ${entry.duration}ms`);
                        }
                    });
                });
                observer.observe({ entryTypes: ['measure'] });
            }
        }

        // Wait for DOM to load before initializing CSV loading
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting CSV fetch...');
        }, { passive: true });
        
        // Add error handling
        window.addEventListener('error', (e) => {
            console.error('Dashboard error:', e.error);
            // Could implement user-friendly error display here
        });
    </script>
    
    <!-- Personalized Recommendation Engine -->
    <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white;">
        <h2 style="text-align: center; margin-bottom: 30px; font-size: 2rem;">üéØ Personal Car Recommendation Engine</h2>
        <p style="text-align: center; margin-bottom: 30px; opacity: 0.9;">Tell us what matters most to you, and we'll find your perfect car match!</p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="preference-slider">
                <label for="costWeight">üí∞ Low Cost (0-10):</label>
                <input type="range" id="costWeight" min="0" max="10" value="7" oninput="updateRecommendations()">
                <span id="costWeightValue">7</span>
            </div>
            
            <div class="preference-slider">
                <label for="tcoWeight">üìä Low TCO (0-10):</label>
                <input type="range" id="tcoWeight" min="0" max="10" value="8" oninput="updateRecommendations()">
                <span id="tcoWeightValue">8</span>
            </div>
            
            <div class="preference-slider">
                <label for="reliabilityWeight">üîß Reliability (0-10):</label>
                <input type="range" id="reliabilityWeight" min="0" max="10" value="9" oninput="updateRecommendations()">
                <span id="reliabilityWeightValue">9</span>
            </div>
            
            <div class="preference-slider">
                <label for="styleWeight">‚ú® Style/Coolness (0-10):</label>
                <input type="range" id="styleWeight" min="0" max="10" value="6" oninput="updateRecommendations()">
                <span id="styleWeightValue">6</span>
            </div>
            
            <div class="preference-slider">
                <label for="fuelWeight">‚õΩ Fuel Efficiency (0-10):</label>
                <input type="range" id="fuelWeight" min="0" max="10" value="7" oninput="updateRecommendations()">
                <span id="fuelWeightValue">7</span>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div>
                <h3 style="margin-bottom: 20px;">üìà Your Weighted Scores</h3>
                <canvas id="personalizedChart" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px;"></canvas>
            </div>
            
            <div>
                <h3 style="margin-bottom: 20px;">‚õΩ Top 5 Recommendations</h3>
                <div id="recommendationsList" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; min-height: 300px;">
                    <!-- Recommendations will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Personalized recommendation system
        let personalizedChart = null;
        
        function updateRecommendations() {
            // Update slider value displays
            document.getElementById('costWeightValue').textContent = document.getElementById('costWeight').value;
            document.getElementById('tcoWeightValue').textContent = document.getElementById('tcoWeight').value;
            document.getElementById('reliabilityWeightValue').textContent = document.getElementById('reliabilityWeight').value;
            document.getElementById('styleWeightValue').textContent = document.getElementById('styleWeight').value;
            document.getElementById('fuelWeightValue').textContent = document.getElementById('fuelWeight').value;
            
            // Calculate weighted scores for all cars
            const weights = {
                cost: parseFloat(document.getElementById('costWeight').value),
                tco: parseFloat(document.getElementById('tcoWeight').value),
                reliability: parseFloat(document.getElementById('reliabilityWeight').value),
                style: parseFloat(document.getElementById('styleWeight').value),
                luxury: parseFloat(document.getElementById('fuelWeight').value)
            };
            
            // Skip if no data loaded yet
            if (!carData || carData.length === 0) return;
            
            const scoredCars = calculateWeightedScores(carData, weights);
            updatePersonalizedChart(scoredCars.slice(0, 10));
            updateRecommendationsList(scoredCars.slice(0, 5));
        }
        
        function calculateWeightedScores(cars, weights) {
            return cars.map(car => {
                // Normalize scores to 0-10 scale
                const maxPrice = Math.max(...cars.map(c => c.price));
                const maxTCO = Math.max(...cars.map(c => c.tco));
                
                const scores = {
                    cost: (1 - (car.price / maxPrice)) * 10, // Lower price = higher score
                    tco: (1 - (car.tco / maxTCO)) * 10,      // Lower TCO = higher score
                    reliability: car.reliability || 7,        // Already 0-10
                    style: car.founderCredibility || 5,       // Use coolness score if available
                    fuel: (1 - (car.fuelCost / 2000)) * 10        // Lower fuel cost = higher score
                };
                
                // Calculate weighted score
                const totalWeight = Object.values(weights).reduce((sum, w) => sum + w, 0);
                const weightedScore = (
                    scores.cost * weights.cost +
                    scores.tco * weights.tco +
                    scores.reliability * weights.reliability +
                    scores.style * weights.style +
                    scores.fuel * weights.fuel
                ) / totalWeight;
                
                return {
                    ...car,
                    scores,
                    weightedScore: Math.round(weightedScore * 100) / 100,
                    recommendation: getRecommendationReason(scores, weights)
                };
            }).sort((a, b) => b.weightedScore - a.weightedScore);
        }
        
        function getRecommendationReason(scores, weights) {
            const topFactors = Object.entries(weights)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 2)
                .map(([factor]) => {
                    switch(factor) {
                        case 'cost': return 'affordable price';
                        case 'tco': return 'low total cost';
                        case 'reliability': return 'proven reliability';
                        case 'style': return 'great style';
                        case 'fuel': return 'excellent fuel economy';
                    }
                });
            
            return `Perfect for: ${topFactors.join(' + ')}`;
        }
        
        function updatePersonalizedChart(topCars) {
            const ctx = document.getElementById('personalizedChart').getContext('2d');
            
            if (personalizedChart) {
                personalizedChart.destroy();
            }
            
            personalizedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topCars.map(car => car.name.substring(0, 15) + '...'),
                    datasets: [{
                        label: 'Weighted Score',
                        data: topCars.map(car => car.weightedScore),
                        backgroundColor: 'rgba(255, 255, 255, 0.8)',
                        borderColor: 'rgba(255, 255, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return topCars[tooltipItems[0].dataIndex].name;
                                },
                                label: function(context) {
                                    const car = topCars[context.dataIndex];
                                    return [
                                        `Weighted Score: ${car.weightedScore}/10`,
                                        `Price: $${car.price.toLocaleString()}`,
                                        `TCO: $${car.tco.toLocaleString()}`,
                                        `Reliability: ${car.reliability}/10`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' }
                        },
                        x: {
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.8)',
                                maxRotation: 45 
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' }
                        }
                    }
                }
            });
        }
        
        function updateRecommendationsList(topCars) {
            const listElement = document.getElementById('recommendationsList');
            
            if (topCars.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; opacity: 0.7;">Loading recommendations...</p>';
                return;
            }
            
            listElement.innerHTML = topCars.map((car, index) => `
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : 'rgba(255,255,255,0.3)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="font-size: 1.1em;">${index + 1}. ${car.name}</strong>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-weight: bold;">
                            ${car.weightedScore}/10
                        </span>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">
                        üí∞ $${car.price.toLocaleString()} | üìä $${car.tco.toLocaleString()} TCO | üîß ${car.reliability}/10
                    </div>
                    <div style="font-size: 0.85em; opacity: 0.8; font-style: italic;">
                        ${car.recommendation}
                    </div>
                </div>
            `).join('');
        }
        
        // Initialize recommendations when data loads
        function initializePersonalizedRecommendations() {
            if (carData && carData.length > 0) {
                updateRecommendations();
            }
        }
        
        // Add to the initialization sequence
        const originalInitializeDashboard = initializeDashboard;
        initializeDashboard = function() {
            originalInitializeDashboard();
            setTimeout(initializePersonalizedRecommendations, 500);
        };
    </script>
    
    <style>
        .preference-slider {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: center;
        }
        
        .preference-slider label {
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .preference-slider input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }
        
        .preference-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .preference-slider input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .preference-slider span {
            font-weight: bold;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            align-self: center;
            min-width: 30px;
        }
        
        @media (max-width: 768px) {
            .preference-slider {
                font-size: 0.8em;
            }
            
            .preference-slider label {
                font-size: 0.8em;
            }
        }
    </style>
</body>
</html>