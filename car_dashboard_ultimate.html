<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive 3-Year TCO Analysis Dashboard for 59 cars with NEW vs USED comparison using real KBB & Edmunds data">
    <meta name="keywords" content="car analysis, TCO, total cost ownership, car buying, depreciation, automotive">
    <title>Ultimate Car Analysis Dashboard - 3-Year TCO Comparison</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #0f1419;
            --secondary-bg: #1a1f29;
            --card-bg: #242937;
            --surface-bg: #2d3748;
            --accent-blue: #3182ce;
            --accent-green: #38a169;
            --accent-orange: #dd6b20;
            --accent-red: #e53e3e;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(90deg, #3182ce 0%, #63b3ed 100%);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: var(--spacing-sm);
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            body {
                padding: var(--spacing-lg);
                font-size: 16px;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--secondary-bg);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 25px 80px var(--shadow-color);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
            z-index: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
                margin: var(--spacing-xs);
                border-radius: var(--border-radius-md);
            }
        }
        
        h1 {
            text-align: center;
            color: var(--text-primary);
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            margin-bottom: var(--spacing-xs);
            font-weight: 700;
            letter-spacing: -0.025em;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            margin-bottom: var(--spacing-xl);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        .subtitle .warning-text {
            color: var(--accent-red);
            font-weight: 600;
            display: block;
            margin-top: var(--spacing-xs);
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--card-bg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            position: sticky;
            top: var(--spacing-sm);
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
                padding: var(--spacing-md);
                position: static;
            }
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: var(--spacing-xs);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .filter-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            background: var(--surface-bg);
            color: var(--text-primary);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .filter-group select:hover {
            border-color: var(--accent-blue);
            background: var(--secondary-bg);
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: var(--spacing-sm);
            }
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform var(--transition-normal);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px var(--shadow-color);
            border-color: var(--accent-blue);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        @media (max-width: 768px) {
            .stat-card {
                padding: var(--spacing-md);
            }
        }
        
        .stat-number {
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(500px, 100%), 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }
        }
        
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px var(--shadow-color);
            transition: all var(--transition-normal);
            position: relative;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px var(--shadow-color);
            border-color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .chart-container {
                padding: var(--spacing-md);
            }
        }
        
        .chart-title {
            font-size: clamp(1rem, 3vw, 1.25rem);
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            letter-spacing: -0.025em;
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }
        
        .chart-canvas {
            position: relative;
            height: clamp(300px, 50vw, 450px);
            width: 100%;
        }
        
        canvas {
            max-height: 450px !important;
            border-radius: var(--border-radius-sm);
        }

        @media (max-width: 768px) {
            .chart-canvas {
                height: 300px;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            animation: modalFadeIn var(--transition-normal) ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(8px);
            }
        }
        
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            margin: 2% auto;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 80px var(--shadow-color);
            animation: modalSlideIn var(--transition-normal) ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: var(--spacing-lg);
                max-height: 85vh;
            }
        }
        
        .close {
            color: var(--text-secondary);
            position: absolute;
            right: var(--spacing-lg);
            top: var(--spacing-lg);
            font-size: 24px;
            font-weight: 500;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--surface-bg);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: var(--text-primary);
            background: var(--accent-red);
            border-color: var(--accent-red);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .close {
                right: var(--spacing-md);
                top: var(--spacing-md);
            }
        }
        
        .car-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .detail-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .detail-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .detail-value {
            font-size: 1.2em;
            color: #34495e;
            margin-bottom: 5px;
        }
        
        .detail-breakdown {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #856404;
        }
        
        .warning-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .table-container {
            margin-top: var(--spacing-xl);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 700px;
                font-size: 0.75rem;
            }
        }
        
        .data-table th {
            background: var(--surface-bg);
            color: var(--text-primary);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .data-table th {
                padding: var(--spacing-sm);
                font-size: 0.7rem;
            }
        }
        
        .data-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-primary);
        }
        
        .data-table tr:hover {
            background: var(--surface-bg);
            transform: scale(1.01);
        }

        .data-table tr:hover td {
            border-color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .data-table td {
                padding: var(--spacing-sm);
            }
        }

        /* NEW VS USED Comparison Section Styles */
        .comparison-section {
            background: linear-gradient(135deg, var(--accent-red), #ee5a24);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin: var(--spacing-xl) 0;
            box-shadow: 0 15px 40px rgba(238, 90, 36, 0.3);
            position: relative;
            overflow: hidden;
        }

        .comparison-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }

        .comparison-title {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            position: relative;
            z-index: 1;
        }

        .comparison-card {
            background: rgba(255, 255, 255, 0.15);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all var(--transition-normal);
        }

        .comparison-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .comparison-card-title {
            margin-bottom: var(--spacing-md);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .comparison-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .savings-highlight {
            text-align: center;
            margin-top: var(--spacing-md);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-green);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .strategy-tip {
            text-align: center;
            margin-top: var(--spacing-xl);
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.2);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .comparison-section {
                padding: var(--spacing-lg);
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .comparison-details {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
        }

        /* Loading states and animations */
        .loading {
            cursor: wait;
        }

        .loading .chart-container,
        .loading .stats-grid,
        .loading .table-container {
            transition: opacity var(--transition-normal);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .chart-container.loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Improved focus states for accessibility */
        .stat-card:focus,
        .chart-container:focus,
        .data-table tr:focus {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background var(--transition-fast);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #ffffff;
                --text-secondary: #ffffff;
                --shadow-color: rgba(255, 255, 255, 0.3);
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .container {
                box-shadow: none;
                border: 1px solid black;
            }
            
            .modal,
            .filters {
                display: none;
            }
        }

        /* Initial loading state */
        body:not(.loaded) {
            overflow: hidden;
        }

        body:not(.loaded)::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-bg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body:not(.loaded)::after {
            content: 'Loading Dashboard...';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 500;
            z-index: 10000;
            animation: pulse 2s infinite;
        }

        /* Smooth reveal animation */
        .loaded .container {
            animation: containerReveal 0.8s ease-out;
        }

        @keyframes containerReveal {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced micro-interactions */
        .stat-card,
        .chart-container,
        .comparison-card {
            will-change: transform;
        }

        .filter-group select:active {
            transform: scale(0.98);
        }

        .data-table tr:active {
            transform: scale(0.995);
        }

        /* Focus visible for better accessibility */
        .filter-group select:focus-visible,
        .stat-card:focus-visible,
        .chart-container:focus-visible,
        .data-table tr:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Ultimate Car Analysis Dashboard</h1>
        <p class="subtitle">
            <strong>3-Year TCO Analysis: Multiple Model Years & Real Market Data</strong><br>
            Compare used vs new across different model years | KBB & Edmunds pricing<br>
            TCO = Purchase Price + Depreciation Loss + Fuel + Maintenance + Insurance (3 years)
        </p>
        
        <div class="filters">
            <div class="filter-group">
                <label for="budgetFilter">Budget Range</label>
                <select id="budgetFilter">
                    <option value="all">All Budgets</option>
                    <option value="under20k">Under $20k</option>
                    <option value="20to30k">$20k - $30k</option>
                    <option value="30to40k">$30k - $40k</option>
                    <option value="40to50k">$40k - $50k</option>
                    <option value="over50k">Over $50k</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="fuelFilter">Fuel Type</label>
                <select id="fuelFilter">
                    <option value="all">All Types</option>
                    <option value="Electric">Electric</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="PHEV">PHEV</option>
                    <option value="Gas">Gas</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="reliabilityFilter">Min Reliability</label>
                <select id="reliabilityFilter">
                    <option value="all">All Ratings</option>
                    <option value="6">6+ Rating</option>
                    <option value="7">7+ Rating</option>
                    <option value="8">8+ Rating</option>
                    <option value="9">9+ Rating</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="brandFilter">Brand</label>
                <select id="brandFilter">
                    <option value="all">All Brands</option>
                </select>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Stats populated by JavaScript -->
        </div>
        
        <div class="color-toggle-container" style="text-align: center; margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
            <h3 style="margin: 0 0 15px 0; font-size: 1.2em;">üé® Chart Color Mode</h3>
            <label for="colorMode" style="font-weight: bold; margin-right: 15px; font-size: 1.1em;">Color all charts by:</label>
            <select id="colorMode" style="padding: 10px 15px; border-radius: 8px; border: none; font-size: 16px; background: white; color: #2c3e50; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <option value="fuel">‚õΩ Fuel Type (Electric/Hybrid/Gas)</option>
                <option value="brand">üè≠ Brand (Tesla/Honda/Toyota/etc)</option>
            </select>
            <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.9;">Toggle this to change colors across all charts!</p>
        </div>
        
        <div class="charts-grid">
            
            <div class="chart-container">
                <h3 class="chart-title">TCO vs Reliability (Click Points for Details)</h3>
                <div class="chart-canvas">
                    <canvas id="tcoReliabilityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Price vs Total Depreciation Loss</h3>
                <div class="chart-canvas">
                    <canvas id="depreciationChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">True TCO by Brand (With Depreciation)</h3>
                <div class="chart-canvas">
                    <canvas id="tcoBrandChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Fuel Type TCO Reality Check</h3>
                <div class="chart-canvas">
                    <canvas id="fuelTypeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Maintenance Cost vs Age</h3>
                <div class="chart-canvas">
                    <canvas id="maintenanceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Insurance Cost Analysis</h3>
                <div class="chart-canvas">
                    <canvas id="insuranceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">EV Depreciation Massacre</h3>
                <div class="chart-canvas">
                    <canvas id="evDepreciationChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Hidden Costs Breakdown</h3>
                <div class="chart-canvas">
                    <canvas id="hiddenCostsChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Best/Worst TCO by Category</h3>
                <div class="chart-canvas">
                    <canvas id="categoryTCOChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Reliability vs Maintenance Costs</h3>
                <div class="chart-canvas">
                    <canvas id="reliabilityMaintenanceChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">üé© Style/Credibility vs TCO</h3>
                <div class="chart-canvas">
                    <canvas id="styleTCOChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table" id="carDataTable">
                <thead>
                    <tr>
                        <th>Car</th>
                        <th>True TCO</th>
                        <th>Purchase Price</th>
                        <th>Depreciation Loss</th>
                        <th>Maintenance</th>
                        <th>Fuel</th>
                        <th>Insurance</th>
                        <th>Reliability</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="carTableBody">
                    <!-- Table populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal for car details -->
    <div id="carModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent">
                <!-- Modal content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Modern chart color palette optimized for dark theme
        const chartColors = {
            electric: '#ef4444',    // Red for EVs (high depreciation)
            hybrid: '#22c55e',      // Green for hybrids (best value)
            phev: '#3b82f6',        // Blue for PHEVs
            gas: '#f59e0b',         // Orange for gas cars
            luxury: '#8b5cf6',      // Purple for luxury
            sports: '#ec4899',      // Pink for sports cars
            reliable: '#10b981',    // Emerald for reliable brands
            unreliable: '#f87171',  // Light red for unreliable
            gradient: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe']
        };

        // Chart.js default configuration for dark theme
        Chart.defaults.color = '#f7fafc';
        Chart.defaults.borderColor = '#4a5568';
        Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(45, 55, 72, 0.95)';
        Chart.defaults.plugins.tooltip.titleColor = '#f7fafc';
        Chart.defaults.plugins.tooltip.bodyColor = '#e2e8f0';
        Chart.defaults.plugins.tooltip.borderColor = '#4a5568';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.scale.ticks.color = '#a0aec0';
        Chart.defaults.scale.title.color = '#e2e8f0';

        // CORRECTED dataset with proper TCO calculations
        const carData = [
            {name: 'Tesla Model 3 (2020)', year: '2020', price: 22000, depreciation: 35, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 8, 
             fuelCost: 825, maintenanceCost: 900, insuranceCost: 1200, founderCredibility: 6,
             tco: 22000 * 0.35 + 825 * 3 + 900 * 3 + 1200 * 3, // 7700 + 2475 + 2700 + 3600 = 16475
             notes: "2020: Already depreciated, better TCO value"},
             
            {name: 'Tesla Model 3 (2022)', year: '2022', price: 25500, depreciation: 45, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 8, 
             fuelCost: 825, maintenanceCost: 900, insuranceCost: 1200, founderCredibility: 5,
             tco: 25500 * 0.45 + 825 * 3 + 900 * 3 + 1200 * 3, // 11475 + 2475 + 2700 + 3600 = 20250
             notes: "2022: Still massive depreciation ahead"},
             
            {name: 'Tesla Model 3 (2025)', year: '2025', price: 40000, depreciation: 40, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 8, 
             fuelCost: 825, maintenanceCost: 700, insuranceCost: 1200, founderCredibility: 5,
             tco: 40000 * 0.40 + 825 * 3 + 700 * 3 + 1200 * 3, // 16000 + 2475 + 2100 + 3600 = 24175
             notes: "2025: New car penalty + depreciation hit"},
            
            {name: 'Tesla Model Y (2023)', year: '2023', price: 37500, depreciation: 32, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 8,
             fuelCost: 825, maintenanceCost: 900, insuranceCost: 1350,
             tco: 37500 * 0.32 + 825 * 3 + 900 * 3 + 1350 * 3, // 12000 + 2475 + 2700 + 4050 = 21225
             notes: "2023: SUV premium + depreciation = expensive TCO"},
             
            {name: 'Tesla Model S (2020)', year: '2020', price: 45000, depreciation: 30, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1200, insuranceCost: 1500,
             tco: 45000 * 0.30 + 825 * 3 + 1200 * 3 + 1500 * 3, // 13500 + 2475 + 3600 + 4500 = 24075
             notes: "2020: Used luxury EV with flattened depreciation"},
             
            {name: 'Tesla Model S (2024)', year: '2024', price: 75000, depreciation: 40, fuel: 'Electric', brand: 'Tesla', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 800, insuranceCost: 1500,
             tco: 75000 * 0.40 + 825 * 3 + 800 * 3 + 1500 * 3, // 30000 + 2475 + 2400 + 4500 = 39375
             notes: "2024: New luxury EV with full depreciation hit"},
             
            {name: 'Chevrolet Bolt EV', price: 17000, depreciation: 55, fuel: 'Electric', brand: 'Chevrolet', category: 'Electric', reliability: 6,
             fuelCost: 825, maintenanceCost: 1800, insuranceCost: 900, // Higher maintenance due to GM reliability issues
             tco: 17000 * 0.55 + 825 * 3 + 1800 * 3 + 900 * 3, // 9350 + 2475 + 5400 + 2700 = 19925
             notes: "Massive depreciation + GM reliability issues = hidden costs"},
             
            {name: 'Chevrolet Bolt EUV', price: 20000, depreciation: 55, fuel: 'Electric', brand: 'Chevrolet', category: 'Electric', reliability: 6,
             fuelCost: 825, maintenanceCost: 1800, insuranceCost: 1000,
             tco: 20000 * 0.55 + 825 * 3 + 1800 * 3 + 1000 * 3, // 11000 + 2475 + 5400 + 3000 = 21875
             notes: "GM quality control problems show up after year 2"},
             
            {name: 'Hyundai Ioniq 5', price: 26000, depreciation: 52, fuel: 'Electric', brand: 'Hyundai', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1200, insuranceCost: 1050,
             tco: 26000 * 0.52 + 825 * 3 + 1200 * 3 + 1050 * 3, // 13520 + 2475 + 3600 + 3150 = 22745
             notes: "Korean EV depreciation is brutal"},
             
            {name: 'Kia EV6', price: 36000, depreciation: 42, fuel: 'Electric', brand: 'Kia', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1200, insuranceCost: 1050,
             tco: 36000 * 0.42 + 825 * 3 + 1200 * 3 + 1050 * 3, // 15120 + 2475 + 3600 + 3150 = 24345
             notes: "Premium EV pricing + depreciation"},
             
            {name: 'BMW i4 (2022)', year: '2022', price: 42000, depreciation: 25, fuel: 'Electric', brand: 'BMW', category: 'Electric', reliability: 8,
             fuelCost: 825, maintenanceCost: 1500, insuranceCost: 1350,
             tco: 42000 * 0.25 + 825 * 3 + 1500 * 3 + 1350 * 3, // 10500 + 2475 + 4500 + 4050 = 21525
             notes: "2022: Used BMW EV, reduced depreciation"},
             
            {name: 'BMW i4 (2024)', year: '2024', price: 57000, depreciation: 32, fuel: 'Electric', brand: 'BMW', category: 'Electric', reliability: 8,
             fuelCost: 825, maintenanceCost: 1200, insuranceCost: 1350,
             tco: 57000 * 0.32 + 825 * 3 + 1200 * 3 + 1350 * 3, // 18240 + 2475 + 3600 + 4050 = 28365
             notes: "2024: New BMW EV with luxury depreciation"},
             
            {name: 'Nissan Leaf', price: 18500, depreciation: 60, fuel: 'Electric', brand: 'Nissan', category: 'Electric', reliability: 5,
             fuelCost: 825, maintenanceCost: 1500, insuranceCost: 900, // Battery replacement risk
             tco: 18500 * 0.60 + 825 * 3 + 1500 * 3 + 900 * 3, // 11100 + 2475 + 4500 + 2700 = 20775
             notes: "Battery degradation = replacement costs"},
             
            {name: 'Volkswagen ID.4', price: 30000, depreciation: 45, fuel: 'Electric', brand: 'Volkswagen', category: 'Electric', reliability: 6,
             fuelCost: 825, maintenanceCost: 2100, insuranceCost: 1050, // VW reliability issues
             tco: 30000 * 0.45 + 825 * 3 + 2100 * 3 + 1050 * 3, // 13500 + 2475 + 6300 + 3150 = 25425
             notes: "German EV teething problems"},
             
            // Now the hybrids and PHEVs (better TCO due to less depreciation)
            {name: 'Toyota RAV4 Hybrid', price: 30500, depreciation: 15, fuel: 'Hybrid', brand: 'Toyota', category: 'Hybrid', reliability: 9,
             fuelCost: 2400, maintenanceCost: 1200, insuranceCost: 600, founderCredibility: 6, // Toyota reliability
             tco: 30500 * 0.15 + 2400 * 3 + 1200 * 3 + 600 * 3, // 4575 + 7200 + 3600 + 1800 = 17175
             notes: "Best value - minimal depreciation + Toyota reliability + outdoor credibility"},
             
            {name: 'Toyota Prius', price: 23000, depreciation: 25, fuel: 'Hybrid', brand: 'Toyota', category: 'Hybrid', reliability: 9,
             fuelCost: 1800, maintenanceCost: 900, insuranceCost: 600,
             tco: 23000 * 0.25 + 1800 * 3 + 900 * 3 + 600 * 3, // 5750 + 5400 + 2700 + 1800 = 15650
             notes: "Maximum efficiency + bulletproof reliability"},
             
            {name: 'Toyota Prius Prime', price: 24000, depreciation: 28, fuel: 'PHEV', brand: 'Toyota', category: 'Hybrid', reliability: 9,
             fuelCost: 1050, maintenanceCost: 1050, insuranceCost: 750,
             tco: 24000 * 0.28 + 1050 * 3 + 1050 * 3 + 750 * 3, // 6720 + 3150 + 3150 + 2250 = 15270
             notes: "PHEV sweet spot - low fuel + low depreciation"},
             
            {name: 'Toyota Camry Hybrid', price: 27500, depreciation: 22, fuel: 'Hybrid', brand: 'Toyota', category: 'Hybrid', reliability: 9,
             fuelCost: 1800, maintenanceCost: 1200, insuranceCost: 600,
             tco: 27500 * 0.22 + 1800 * 3 + 1200 * 3 + 600 * 3, // 6050 + 5400 + 3600 + 1800 = 16850
             notes: "Sedan efficiency + Toyota quality"},
             
            {name: 'Honda Accord Hybrid (2022)', year: '2022', price: 26000, depreciation: 25, fuel: 'Hybrid', brand: 'Honda', category: 'Hybrid', reliability: 9,
             fuelCost: 1950, maintenanceCost: 1500, insuranceCost: 750,
             tco: 26000 * 0.25 + 1950 * 3 + 1500 * 3 + 750 * 3, // 6500 + 5850 + 4500 + 2250 = 19100
             notes: "2022: Honda reliability with hybrid efficiency"},
             
            {name: 'Honda CR-V Hybrid (2023)', year: '2023', price: 29000, depreciation: 24, fuel: 'Hybrid', brand: 'Honda', category: 'SUV', reliability: 8,
             fuelCost: 2550, maintenanceCost: 1500, insuranceCost: 750,
             tco: 29000 * 0.24 + 2550 * 3 + 1500 * 3 + 750 * 3, // 6960 + 7650 + 4500 + 2250 = 21360
             notes: "SUV practicality + hybrid efficiency"},
             
            {name: 'Lexus ES Hybrid (2021)', year: '2021', price: 34000, depreciation: 27, fuel: 'Hybrid', brand: 'Lexus', category: 'Hybrid', reliability: 9,
             fuelCost: 2100, maintenanceCost: 1200, insuranceCost: 900,
             tco: 34000 * 0.27 + 2100 * 3 + 1200 * 3 + 900 * 3, // 9180 + 6300 + 3600 + 2700 = 21780
             notes: "Luxury hybrid with Toyota reliability"},
             
            {name: 'BMW 330e', price: 25250, depreciation: 38, fuel: 'PHEV', brand: 'BMW', category: 'Luxury', reliability: 7,
             fuelCost: 1200, maintenanceCost: 2400, insuranceCost: 1050, // BMW maintenance costs
             tco: 25250 * 0.38 + 1200 * 3 + 2400 * 3 + 1050 * 3, // 9595 + 3600 + 7200 + 3150 = 23545
             notes: "BMW service costs kill PHEV savings"},
             
            // Gas cars (moderate TCO)
            {name: 'Honda Civic (2019)', year: '2019', price: 16000, depreciation: 25, fuel: 'Gas', brand: 'Honda', category: 'Compact', reliability: 9,
             fuelCost: 3000, maintenanceCost: 1200, insuranceCost: 600, founderCredibility: 4,
             tco: 16000 * 0.25 + 3000 * 3 + 1200 * 3 + 600 * 3, // 4000 + 9000 + 3600 + 1800 = 18400
             notes: "2019: Great value, depreciation curve flattened"},
             
            {name: 'Honda Civic (2022)', year: '2022', price: 21000, depreciation: 31, fuel: 'Gas', brand: 'Honda', category: 'Compact', reliability: 9,
             fuelCost: 3000, maintenanceCost: 1200, insuranceCost: 600, founderCredibility: 4,
             tco: 21000 * 0.31 + 3000 * 3 + 1200 * 3 + 600 * 3, // 6510 + 9000 + 3600 + 1800 = 20910
             notes: "2022: Moderate depreciation remaining"},
             
            {name: 'Honda Civic (2024)', year: '2024', price: 28000, depreciation: 35, fuel: 'Gas', brand: 'Honda', category: 'Compact', reliability: 9,
             fuelCost: 3000, maintenanceCost: 1000, insuranceCost: 600, founderCredibility: 4,
             tco: 28000 * 0.35 + 3000 * 3 + 1000 * 3 + 600 * 3, // 9800 + 9000 + 3000 + 1800 = 23600
             notes: "2024: New car premium + full depreciation"},
             
            {name: 'Genesis G70 (2019)', year: '2019', price: 19500, depreciation: 25, fuel: 'Gas', brand: 'Genesis', category: 'Luxury', reliability: 8,
             fuelCost: 4200, maintenanceCost: 1800, insuranceCost: 900, founderCredibility: 7,
             tco: 19500 * 0.25 + 4200 * 3 + 1800 * 3 + 900 * 3, // 4875 + 12600 + 5400 + 2700 = 25575
             notes: "2019: Used luxury sedan, depreciation slowed"},
             
            {name: 'Genesis G70 (2021)', year: '2021', price: 24500, depreciation: 43, fuel: 'Gas', brand: 'Genesis', category: 'Luxury', reliability: 8,
             fuelCost: 4200, maintenanceCost: 1800, insuranceCost: 900, founderCredibility: 7, // Free maintenance first 3 years
             tco: 24500 * 0.43 + 4200 * 3 + 1800 * 3 + 900 * 3, // 10535 + 12600 + 5400 + 2700 = 31235
             notes: "2021: Still depreciating fast + premium fuel"},
             
            {name: 'Genesis G70 (2024)', year: '2024', price: 38000, depreciation: 45, fuel: 'Gas', brand: 'Genesis', category: 'Luxury', reliability: 8,
             fuelCost: 4200, maintenanceCost: 1200, insuranceCost: 900, founderCredibility: 8,
             tco: 38000 * 0.45 + 4200 * 3 + 1200 * 3 + 900 * 3, // 17100 + 12600 + 3600 + 2700 = 36000
             notes: "2024: New luxury sedan with full depreciation hit"},
             
            {name: 'BMW 330i', price: 26000, depreciation: 28, fuel: 'Gas', brand: 'BMW', category: 'Luxury', reliability: 7,
             fuelCost: 3600, maintenanceCost: 2400, insuranceCost: 1050,
             tco: 26000 * 0.28 + 3600 * 3 + 2400 * 3 + 1050 * 3, // 7280 + 10800 + 7200 + 3150 = 28430
             notes: "BMW maintenance premium"},
             
            {name: 'Audi A4', price: 27000, depreciation: 30, fuel: 'Gas', brand: 'Audi', category: 'Luxury', reliability: 7,
             fuelCost: 3600, maintenanceCost: 2700, insuranceCost: 1200,
             tco: 27000 * 0.30 + 3600 * 3 + 2700 * 3 + 1200 * 3, // 8100 + 10800 + 8100 + 3600 = 30600
             notes: "German luxury = expensive everything"},
             
            {name: 'Mercedes C300', price: 30000, depreciation: 32, fuel: 'Gas', brand: 'Mercedes', category: 'Luxury', reliability: 6,
             fuelCost: 3900, maintenanceCost: 3000, insuranceCost: 1200,
             tco: 30000 * 0.32 + 3900 * 3 + 3000 * 3 + 1200 * 3, // 9600 + 11700 + 9000 + 3600 = 33900
             notes: "Mercedes service costs are brutal"},
             
            {name: 'Lexus IS', price: 27000, depreciation: 25, fuel: 'Gas', brand: 'Lexus', category: 'Luxury', reliability: 9,
             fuelCost: 4500, maintenanceCost: 1200, insuranceCost: 900,
             tco: 27000 * 0.25 + 4500 * 3 + 1200 * 3 + 900 * 3, // 6750 + 13500 + 3600 + 2700 = 26550
             notes: "Premium fuel costs but Toyota reliability"},
             
            {name: 'Acura TLX', price: 29500, depreciation: 28, fuel: 'Gas', brand: 'Acura', category: 'Luxury', reliability: 8,
             fuelCost: 4200, maintenanceCost: 1500, insuranceCost: 900,
             tco: 29500 * 0.28 + 4200 * 3 + 1500 * 3 + 900 * 3, // 8260 + 12600 + 4500 + 2700 = 28060
             notes: "Honda luxury with reasonable costs"},
             
            {name: 'Subaru Outback', price: 27000, depreciation: 28, fuel: 'Gas', brand: 'Subaru', category: 'SUV', reliability: 9,
             fuelCost: 3300, maintenanceCost: 2100, insuranceCost: 1200,
             tco: 27000 * 0.28 + 3300 * 3 + 2100 * 3 + 1200 * 3, // 7560 + 9900 + 6300 + 3600 = 27360
             notes: "AWD utility with head gasket risks"},
             
            {name: 'Mazda CX-5', price: 24000, depreciation: 30, fuel: 'Gas', brand: 'Mazda', category: 'SUV', reliability: 8,
             fuelCost: 3600, maintenanceCost: 1800, insuranceCost: 1050,
             tco: 24000 * 0.30 + 3600 * 3 + 1800 * 3 + 1050 * 3, // 7200 + 10800 + 5400 + 3150 = 26550
             notes: "Solid SUV with moderate costs"},
             
            // Sports cars (high TCO due to everything)
            {name: 'Porsche Cayman', price: 44500, depreciation: 22, fuel: 'Gas', brand: 'Porsche', category: 'Sports', reliability: 9,
             fuelCost: 4800, maintenanceCost: 3600, insuranceCost: 2100,
             tco: 44500 * 0.22 + 4800 * 3 + 3600 * 3 + 2100 * 3, // 9790 + 14400 + 10800 + 6300 = 41290
             notes: "Porsche everything = expensive everything"},
             
            {name: 'BMW M240i', price: 36000, depreciation: 30, fuel: 'Gas', brand: 'BMW', category: 'Sports', reliability: 7,
             fuelCost: 4200, maintenanceCost: 2700, insuranceCost: 1500,
             tco: 36000 * 0.30 + 4200 * 3 + 2700 * 3 + 1500 * 3, // 10800 + 12600 + 8100 + 4500 = 36000
             notes: "Performance + BMW tax"},
             
            {name: 'Toyota GR86', price: 28500, depreciation: 25, fuel: 'Gas', brand: 'Toyota', category: 'Sports', reliability: 8,
             fuelCost: 4800, maintenanceCost: 1200, insuranceCost: 1200,
             tco: 28500 * 0.25 + 4800 * 3 + 1200 * 3 + 1200 * 3, // 7125 + 14400 + 3600 + 3600 = 28725
             notes: "Sports car fun with Toyota reliability"},
             
            // NEW ADDITIONS: Popular EVs, Budget Champions, Cheap Luxury
            {name: 'Ford Mustang Mach-E (2022)', year: '2022', price: 32000, depreciation: 42, fuel: 'Electric', brand: 'Ford', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1200, insuranceCost: 1050,
             tco: 32000 * 0.42 + 825 * 3 + 1200 * 3 + 1050 * 3, // 13440 + 2475 + 3600 + 3150 = 22665
             notes: "2022: Used American EV, some depreciation absorbed"},
             
            {name: 'Ford Mustang Mach-E (2024)', year: '2024', price: 42000, depreciation: 50, fuel: 'Electric', brand: 'Ford', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1000, insuranceCost: 1050,
             tco: 42000 * 0.50 + 825 * 3 + 1000 * 3 + 1050 * 3, // 21000 + 2475 + 3000 + 3150 = 29625
             notes: "2024: New Mach-E with brutal depreciation ahead"},
             
            {name: 'Polestar 2 (2022)', year: '2022', price: 35000, depreciation: 35, fuel: 'Electric', brand: 'Polestar', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1500, insuranceCost: 1200,
             tco: 35000 * 0.35 + 825 * 3 + 1500 * 3 + 1200 * 3, // 12250 + 2475 + 4500 + 3600 = 22825
             notes: "2022: Used Swedish EV, better value than new"},
             
            {name: 'Polestar 2 (2024)', year: '2024', price: 45000, depreciation: 45, fuel: 'Electric', brand: 'Polestar', category: 'Electric', reliability: 7,
             fuelCost: 825, maintenanceCost: 1200, insuranceCost: 1200,
             tco: 45000 * 0.45 + 825 * 3 + 1200 * 3 + 1200 * 3, // 20250 + 2475 + 3600 + 3600 = 29925
             notes: "2024: New Polestar with premium pricing"},
             
            {name: 'Nissan Ariya', price: 37500, depreciation: 50, fuel: 'Electric', brand: 'Nissan', category: 'Electric', reliability: 6,
             fuelCost: 825, maintenanceCost: 1350, insuranceCost: 1050,
             tco: 37500 * 0.50 + 825 * 3 + 1350 * 3 + 1050 * 3, // 18750 + 2475 + 4050 + 3150 = 28425
             notes: "Newer Nissan EV SUV, better than Leaf reliability"},
             
            {name: 'Nissan Sentra', price: 16500, depreciation: 38, fuel: 'Gas', brand: 'Nissan', category: 'Budget', reliability: 7,
             fuelCost: 3150, maintenanceCost: 1350, insuranceCost: 750,
             tco: 16500 * 0.38 + 3150 * 3 + 1350 * 3 + 750 * 3, // 6270 + 9450 + 4050 + 2250 = 22020
             notes: "Ultra-budget reliable sedan option"},
             
            {name: 'Kia Forte', price: 14000, depreciation: 42, fuel: 'Gas', brand: 'Kia', category: 'Budget', reliability: 7,
             fuelCost: 3000, maintenanceCost: 1500, insuranceCost: 900,
             tco: 14000 * 0.42 + 3000 * 3 + 1500 * 3 + 900 * 3, // 5880 + 9000 + 4500 + 2700 = 22080
             notes: "Value compact sedan with 10-year warranty"},
             
            {name: 'Hyundai Accent', price: 12500, depreciation: 45, fuel: 'Gas', brand: 'Hyundai', category: 'Budget', reliability: 6,
             fuelCost: 3300, maintenanceCost: 1650, insuranceCost: 1050,
             tco: 12500 * 0.45 + 3300 * 3 + 1650 * 3 + 1050 * 3, // 5625 + 9900 + 4950 + 3150 = 23625
             notes: "Ultra-budget option, discontinued 2023"},
             
            {name: 'Cadillac CT4', price: 26000, depreciation: 40, fuel: 'Gas', brand: 'Cadillac', category: 'Luxury', reliability: 6,
             fuelCost: 3900, maintenanceCost: 2400, insuranceCost: 1200,
             tco: 26000 * 0.40 + 3900 * 3 + 2400 * 3 + 1200 * 3, // 10400 + 11700 + 7200 + 3600 = 32900
             notes: "American luxury revival, competitive pricing"},
             
            {name: 'Lexus NX Hybrid', price: 36000, depreciation: 20, fuel: 'Hybrid', brand: 'Lexus', category: 'Luxury', reliability: 9,
             fuelCost: 2700, maintenanceCost: 1500, insuranceCost: 1050,
             tco: 36000 * 0.20 + 2700 * 3 + 1500 * 3 + 1050 * 3, // 7200 + 8100 + 4500 + 3150 = 22950
             notes: "Reliable luxury hybrid SUV, excellent retention"},
             
            {name: 'Range Rover Evoque (2019)', year: '2019', price: 28000, depreciation: 35, fuel: 'Gas', brand: 'Range Rover', category: 'Luxury', reliability: 5,
             fuelCost: 4650, maintenanceCost: 3600, insuranceCost: 1800, founderCredibility: 9,
             tco: 28000 * 0.35 + 4650 * 3 + 3600 * 3 + 1800 * 3, // 9800 + 13950 + 10800 + 5400 = 39950
             notes: "2019: Used Range Rover, still stylish but used"},
             
            {name: 'Range Rover Evoque (2024)', year: '2024', price: 48000, depreciation: 50, fuel: 'Gas', brand: 'Range Rover', category: 'Luxury', reliability: 5,
             fuelCost: 4650, maintenanceCost: 3000, insuranceCost: 1800, founderCredibility: 10,
             tco: 48000 * 0.50 + 4650 * 3 + 3000 * 3 + 1800 * 3, // 24000 + 13950 + 9000 + 5400 = 52350
             notes: "2024: New Range Rover, maximum style, maximum cost"},
             
            // More BMW variants (high style)
            {name: 'BMW M240i (2020)', year: '2020', price: 28000, depreciation: 25, fuel: 'Gas', brand: 'BMW', category: 'Sports', reliability: 7,
             fuelCost: 4200, maintenanceCost: 2700, insuranceCost: 1500, founderCredibility: 8,
             tco: 28000 * 0.25 + 4200 * 3 + 2700 * 3 + 1500 * 3, // 7000 + 12600 + 8100 + 4500 = 32200
             notes: "2020: Used BMW performance, good value"},
             
            {name: 'BMW M240i (2024)', year: '2024', price: 46000, depreciation: 35, fuel: 'Gas', brand: 'BMW', category: 'Sports', reliability: 7,
             fuelCost: 4200, maintenanceCost: 2400, insuranceCost: 1500, founderCredibility: 9,
             tco: 46000 * 0.35 + 4200 * 3 + 2400 * 3 + 1500 * 3, // 16100 + 12600 + 7200 + 4500 = 40400
             notes: "2024: New BMW performance with depreciation hit"},
             
            // More Honda variants (practical)
            {name: 'Honda Civic Type R (2020)', year: '2020', price: 32000, depreciation: 20, fuel: 'Gas', brand: 'Honda', category: 'Sports', reliability: 9,
             fuelCost: 3600, maintenanceCost: 1500, insuranceCost: 1200, founderCredibility: 7,
             tco: 32000 * 0.20 + 3600 * 3 + 1500 * 3 + 1200 * 3, // 6400 + 10800 + 4500 + 3600 = 25300
             notes: "2020: Used Type R, excellent retention"},
             
            {name: 'Honda Civic Type R (2023)', year: '2023', price: 42000, depreciation: 25, fuel: 'Gas', brand: 'Honda', category: 'Sports', reliability: 9,
             fuelCost: 3600, maintenanceCost: 1200, insuranceCost: 1200, founderCredibility: 8,
             tco: 42000 * 0.25 + 3600 * 3 + 1200 * 3 + 1200 * 3, // 10500 + 10800 + 3600 + 3600 = 28500
             notes: "2023: New Type R with markup premium"},
             
            // Maximum style cars (Porsche)
            {name: 'Porsche 911 (2019)', year: '2019', price: 85000, depreciation: 15, fuel: 'Gas', brand: 'Porsche', category: 'Sports', reliability: 9,
             fuelCost: 5400, maintenanceCost: 4000, insuranceCost: 2500, founderCredibility: 10,
             tco: 85000 * 0.15 + 5400 * 3 + 4000 * 3 + 2500 * 3, // 12750 + 16200 + 12000 + 7500 = 48450
             notes: "2019: Used 911, ultimate founder car, excellent retention"},
             
            {name: 'Porsche 911 (2024)', year: '2024', price: 115000, depreciation: 20, fuel: 'Gas', brand: 'Porsche', category: 'Sports', reliability: 9,
             fuelCost: 5400, maintenanceCost: 3500, insuranceCost: 2500, founderCredibility: 10,
             tco: 115000 * 0.20 + 5400 * 3 + 3500 * 3 + 2500 * 3, // 23000 + 16200 + 10500 + 7500 = 57200
             notes: "2024: New 911, maximum credibility, maximum cost"},
             
            {name: 'Porsche Cayman (2020)', year: '2020', price: 55000, depreciation: 18, fuel: 'Gas', brand: 'Porsche', category: 'Sports', reliability: 9,
             fuelCost: 4800, maintenanceCost: 3600, insuranceCost: 2100, founderCredibility: 9,
             tco: 55000 * 0.18 + 4800 * 3 + 3600 * 3 + 2100 * 3, // 9900 + 14400 + 10800 + 6300 = 41400
             notes: "2020: Used Cayman, sports car credibility"},
             
            {name: 'Porsche Cayman (2024)', year: '2024', price: 68000, depreciation: 22, fuel: 'Gas', brand: 'Porsche', category: 'Sports', reliability: 9,
             fuelCost: 4800, maintenanceCost: 3200, insuranceCost: 2100, founderCredibility: 10,
             tco: 68000 * 0.22 + 4800 * 3 + 3200 * 3 + 2100 * 3, // 14960 + 14400 + 9600 + 6300 = 45260
             notes: "2024: New Cayman with perfect style score"},
             
            // PERSONAL CAR: User's actual Scion xB
            {name: 'Scion xB (2011) - Personal', year: '2011', price: 2000, depreciation: 5, fuel: 'Gas', brand: 'Scion', category: 'Budget', reliability: 6,
             fuelCost: 3300, maintenanceCost: 2400, insuranceCost: 800, founderCredibility: 3, // Higher maintenance due to 120k miles + battery issues
             tco: 2000 * 0.05 + 3300 * 3 + 2400 * 3 + 800 * 3, // 100 + 9900 + 7200 + 2400 = 19600
             notes: "Actual owned car: $2k shipping cost, 120k miles, battery issues - but unbeatable entry cost"},
        ];

        let filteredData = [...carData];
        let charts = {};

        // Populate brand filter
        function populateBrandFilter() {
            const brandFilter = document.getElementById('brandFilter');
            const brands = [...new Set(carData.map(car => car.brand))].sort();
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });
        }

        // Debounce function for performance
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Apply filters with performance optimization
        function applyFilters() {
            const budget = document.getElementById('budgetFilter').value;
            const fuel = document.getElementById('fuelFilter').value;
            const reliability = document.getElementById('reliabilityFilter').value;
            const brand = document.getElementById('brandFilter').value;

            filteredData = carData.filter(car => {
                // Budget filter
                if (budget !== 'all') {
                    switch(budget) {
                        case 'under20k': if (car.price >= 20000) return false; break;
                        case '20to30k': if (car.price < 20000 || car.price >= 30000) return false; break;
                        case '30to40k': if (car.price < 30000 || car.price >= 40000) return false; break;
                        case '40to50k': if (car.price < 40000 || car.price >= 50000) return false; break;
                        case 'over50k': if (car.price < 50000) return false; break;
                    }
                }

                // Fuel filter
                if (fuel !== 'all' && car.fuel !== fuel) return false;

                // Reliability filter
                if (reliability !== 'all' && car.reliability < parseInt(reliability)) return false;

                // Brand filter
                if (brand !== 'all' && car.brand !== brand) return false;

                return true;
            });

            updateDashboard();
        }

        // Debounced version of applyFilters for performance
        const debouncedApplyFilters = debounce(applyFilters, 150);

        // Update statistics
        function updateStats() {
            const avgTCO = filteredData.reduce((sum, car) => sum + car.tco, 0) / filteredData.length;
            const avgDepreciation = filteredData.reduce((sum, car) => sum + (car.price * car.depreciation / 100), 0) / filteredData.length;
            const avgMaintenance = filteredData.reduce((sum, car) => sum + car.maintenanceCost, 0) / filteredData.length;
            const avgFuel = filteredData.reduce((sum, car) => sum + car.fuelCost, 0) / filteredData.length;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${filteredData.length}</div>
                    <div class="stat-label">Cars Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgTCO).toLocaleString()}</div>
                    <div class="stat-label">Average True TCO</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgDepreciation).toLocaleString()}</div>
                    <div class="stat-label">Average Depreciation Hit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgMaintenance).toLocaleString()}</div>
                    <div class="stat-label">Average Annual Maintenance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgFuel).toLocaleString()}</div>
                    <div class="stat-label">Average Annual Fuel Cost</div>
                </div>
            `;
        }

        // Show car details modal with accessibility
        function showCarDetails(car) {
            performance.mark('modal-open-start');
            const depreciationLoss = car.price * car.depreciation / 100;
            const totalFuelCost = car.fuelCost * 3;
            const totalMaintenanceCost = car.maintenanceCost * 3;
            const totalInsuranceCost = car.insuranceCost * 3;

            const modalContent = `
                <h2>${car.name} - Complete TCO Breakdown</h2>
                
                <div class="warning">
                    <div class="warning-title">‚ö†Ô∏è TCO Reality Check</div>
                    ${car.notes}
                </div>
                
                <div class="car-detail-grid">
                    <div class="detail-card">
                        <div class="detail-title">üí∞ Total Cost of Ownership (3 Years)</div>
                        <div class="detail-value">$${car.tco.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            All costs included over 3 years
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üìâ Depreciation Hit</div>
                        <div class="detail-value">$${depreciationLoss.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            ${car.depreciation}% of $${car.price.toLocaleString()} purchase price<br>
                            This is money you'll never get back
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">‚õΩ Fuel Costs (3 Years)</div>
                        <div class="detail-value">$${totalFuelCost.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            $${car.fuelCost.toLocaleString()}/year √ó 3 years<br>
                            Based on 210 miles/week commute
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üîß Maintenance (3 Years)</div>
                        <div class="detail-value">$${totalMaintenanceCost.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            $${car.maintenanceCost.toLocaleString()}/year √ó 3 years<br>
                            Includes repairs, service, parts
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üõ°Ô∏è Insurance (3 Years)</div>
                        <div class="detail-value">$${totalInsuranceCost.toLocaleString()}</div>
                        <div class="detail-breakdown">
                            $${car.insuranceCost.toLocaleString()}/year √ó 3 years<br>
                            Based on SF rates for ${car.category}
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">‚≠ê Reliability Score</div>
                        <div class="detail-value">${car.reliability}/10</div>
                        <div class="detail-breakdown">
                            Based on long-term owner surveys<br>
                            Higher = fewer surprise repairs
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üìä Cost Breakdown</div>
                        <div class="detail-value">
                            Depreciation: ${Math.round(depreciationLoss/car.tco*100)}%<br>
                            Fuel: ${Math.round(totalFuelCost/car.tco*100)}%<br>
                            Maintenance: ${Math.round(totalMaintenanceCost/car.tco*100)}%<br>
                            Insurance: ${Math.round(totalInsuranceCost/car.tco*100)}%
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">üí° Bottom Line</div>
                        <div class="detail-value">
                            ${car.tco < 20000 ? "üü¢ Great Value" : 
                              car.tco < 25000 ? "üü° Decent Value" :
                              car.tco < 30000 ? "üü† Expensive" : "üî¥ Very Expensive"}
                        </div>
                        <div class="detail-breakdown">
                            Monthly cost: $${Math.round(car.tco/36).toLocaleString()}<br>
                            Daily cost: $${Math.round(car.tco/1095).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            const modal = document.getElementById('carModal');
            modal.style.display = 'block';
            
            // Focus management for accessibility
            modal.setAttribute('aria-hidden', 'false');
            const closeButton = modal.querySelector('.close');
            closeButton.focus();
            
            // Trap focus within modal
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            lastFocusable.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            firstFocusable.focus();
                            e.preventDefault();
                        }
                    }
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            performance.mark('modal-open-end');
            performance.measure('Modal Open', 'modal-open-start', 'modal-open-end');
        }
        
        // Close modal function
        function closeModal() {
            const modal = document.getElementById('carModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            // Return focus to triggering element if possible
            document.querySelector('.data-table tr[tabindex="0"]')?.focus();
        }

        // Create table
        function updateTable() {
            const tbody = document.getElementById('carTableBody');
            const sortedData = [...filteredData].sort((a, b) => a.tco - b.tco);
            
            tbody.innerHTML = sortedData.map((car, index) => {
                const rankBadge = index < 5 ? 'üèÜ' : index < 10 ? 'ü•à' : index < 20 ? 'ü•â' : '';
                const tcoColor = car.tco < 20000 ? 'color: var(--accent-green)' : 
                                car.tco < 25000 ? 'color: var(--text-primary)' : 
                                car.tco < 30000 ? 'color: var(--accent-orange)' : 'color: var(--accent-red)';
                
                return `
                    <tr onclick="showCarDetails(${JSON.stringify(car).replace(/"/g, '&quot;')})" 
                        role="button" tabindex="0" 
                        onkeypress="if(event.key==='Enter')showCarDetails(${JSON.stringify(car).replace(/"/g, '&quot;')})" 
                        aria-label="View details for ${car.name}">
                        <td><strong>${rankBadge} ${car.name}</strong></td>
                        <td><strong style="${tcoColor}">$${car.tco.toLocaleString()}</strong></td>
                        <td>$${car.price.toLocaleString()}</td>
                        <td>$${Math.round(car.price * car.depreciation / 100).toLocaleString()}</td>
                        <td>$${car.maintenanceCost.toLocaleString()}/yr</td>
                        <td>$${car.fuelCost.toLocaleString()}/yr</td>
                        <td>$${car.insuranceCost.toLocaleString()}/yr</td>
                        <td>${car.reliability}/10 ${'‚≠ê'.repeat(Math.floor(car.reliability / 2))}</td>
                        <td><span style="font-size: 0.8rem; color: var(--text-secondary)">üëÜ Details</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Chart creation functions with click handlers
        function createNewUsedChart() {
            const ctx = document.getElementById('newUsedChart').getContext('2d');
            if (charts.newUsed) charts.newUsed.destroy();
            
            // Sample data showing new vs used TCO differences for popular cars
            const comparisonData = [
                {car: 'Tesla Model 3', newTCO: 64761, usedTCO: 45750, savings: 19011},
                {car: 'Honda Civic', newTCO: 44450, usedTCO: 32760, savings: 11690},
                {car: 'BMW i4', newTCO: 83005, usedTCO: 62525, savings: 20480},
                {car: 'Toyota RAV4 Hybrid', newTCO: 52000, usedTCO: 38400, savings: 13600},
                {car: 'Genesis G70', newTCO: 48500, usedTCO: 35200, savings: 13300},
                {car: 'Hyundai Ioniq 5', newTCO: 58000, usedTCO: 39600, savings: 18400},
                {car: 'Lexus ES Hybrid', newTCO: 55000, usedTCO: 41200, savings: 13800},
                {car: 'Audi A4', newTCO: 51200, usedTCO: 38900, savings: 12300}
            ];
            
            charts.newUsed = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: comparisonData.map(d => d.car),
                    datasets: [
                        {
                            label: 'NEW Car 3-Year TCO',
                            data: comparisonData.map(d => d.newTCO),
                            backgroundColor: filteredData.filter(car => car.fuel === 'Electric').map(car => getCarColor(car)),
                            borderColor: '#dc2626',
                            borderWidth: 2,
                            borderRadius: 4
                        },
                        {
                            label: 'USED Car 3-Year TCO',
                            data: comparisonData.map(d => d.usedTCO),
                            backgroundColor: filteredData.filter(car => car.fuel === 'Hybrid' || car.fuel === 'PHEV').map(car => getCarColor(car)),
                            borderColor: '#16a34a',
                            borderWidth: 2,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const savings = comparisonData[dataIndex].savings;
                                    return [`üí∞ Save $${savings.toLocaleString()} buying used!`];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Car Models' },
                            ticks: { maxRotation: 45 }
                        },
                        y: {
                            title: { display: true, text: '3-Year TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createTCOReliabilityChart() {
            const ctx = document.getElementById('tcoReliabilityChart').getContext('2d');
            if (charts.tcoReliability) charts.tcoReliability.destroy();
            
            charts.tcoReliability = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map((car, index) => ({
                            x: car.reliability,
                            y: car.tco,
                            label: car.name,
                            carIndex: index
                        })),
                        backgroundColor: filteredData.map(car => getCarColor(car)),
                        pointRadius: 10,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            showCarDetails(filteredData[dataIndex]);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.tco.toLocaleString()} TCO, ${car.reliability}/10 reliability (Click for details)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Reliability Score (1-10)' },
                            min: 4, max: 10
                        },
                        y: {
                            title: { display: true, text: 'True 3-Year TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDepreciationChart() {
            const ctx = document.getElementById('depreciationChart').getContext('2d');
            if (charts.depreciation) charts.depreciation.destroy();
            
            charts.depreciation = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: car.price,
                            y: car.price * car.depreciation / 100,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => getCarColor(car)),
                        pointRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.price.toLocaleString()} ‚Üí loses $${Math.round(car.price * car.depreciation / 100).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Purchase Price ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'Total Depreciation Loss ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTCOBrandChart() {
            const ctx = document.getElementById('tcoBrandChart').getContext('2d');
            if (charts.tcoBrand) charts.tcoBrand.destroy();
            
            const brandData = {};
            filteredData.forEach(car => {
                if (!brandData[car.brand]) {
                    brandData[car.brand] = [];
                }
                brandData[car.brand].push(car.tco);
            });

            const brands = Object.keys(brandData).map(brand => ({
                brand: brand,
                avgTCO: brandData[brand].reduce((sum, tco) => sum + tco, 0) / brandData[brand].length,
                count: brandData[brand].length
            })).sort((a, b) => a.avgTCO - b.avgTCO);

            charts.tcoBrand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brands.map(b => `${b.brand}\\n(${b.count} cars)`),
                    datasets: [{
                        label: 'Average True TCO',
                        data: brands.map(b => b.avgTCO),
                        backgroundColor: brands.map(b => {
                            if (b.avgTCO < 20000) return '#2ecc71';
                            if (b.avgTCO < 25000) return '#f39c12';
                            if (b.avgTCO < 30000) return '#e67e22';
                            return '#e74c3c';
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const brand = brands[context.dataIndex];
                                    return `${brand.brand}: $${context.parsed.y.toLocaleString()} avg TCO (${brand.count} models)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Average True TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createFuelTypeChart() {
            const ctx = document.getElementById('fuelTypeChart').getContext('2d');
            if (charts.fuelType) charts.fuelType.destroy();
            
            const fuelData = {};
            filteredData.forEach(car => {
                if (!fuelData[car.fuel]) {
                    fuelData[car.fuel] = [];
                }
                fuelData[car.fuel].push(car.tco);
            });

            const fuelTypes = Object.keys(fuelData).map(fuel => ({
                fuel: fuel,
                avgTCO: fuelData[fuel].reduce((sum, tco) => sum + tco, 0) / fuelData[fuel].length,
                count: fuelData[fuel].length
            }));

            charts.fuelType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fuelTypes.map(f => `${f.fuel}\\n($${Math.round(f.avgTCO/1000)}k avg)`),
                    datasets: [{
                        label: 'Average TCO by Fuel Type',
                        data: fuelTypes.map(f => f.avgTCO),
                        backgroundColor: fuelTypes.map(f => {
                            switch(f.fuel) {
                                case 'Electric': return '#e74c3c'; // Red - highest TCO due to depreciation
                                case 'Hybrid': return '#2ecc71'; // Green - best TCO
                                case 'PHEV': return '#3498db'; // Blue - middle
                                case 'Gas': return '#f39c12'; // Orange - middle-high
                                default: return '#95a5a6';
                            }
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const fuel = fuelTypes[context.dataIndex];
                                    return `${fuel.fuel}: $${context.parsed.y.toLocaleString()} avg TCO (${fuel.count} cars)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Average True TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMaintenanceChart() {
            const ctx = document.getElementById('maintenanceChart').getContext('2d');
            if (charts.maintenance) charts.maintenance.destroy();
            
            charts.maintenance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: 2024 - Math.floor(Math.random() * 5 + 2019), // Approximate age
                            y: car.maintenanceCost,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => {
                            return getCarColor(car);
                        }),
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.maintenanceCost.toLocaleString()}/year maintenance`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Vehicle Age (Years)' } },
                        y: { 
                            title: { display: true, text: 'Annual Maintenance Cost ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createInsuranceChart() {
            const ctx = document.getElementById('insuranceChart').getContext('2d');
            if (charts.insurance) charts.insurance.destroy();
            
            charts.insurance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: car.price,
                            y: car.insuranceCost,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => getCarColor(car)),
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: $${car.insuranceCost.toLocaleString()}/year insurance`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Vehicle Price ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        y: { 
                            title: { display: true, text: 'Annual Insurance Cost ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createEVDepreciationChart() {
            const ctx = document.getElementById('evDepreciationChart').getContext('2d');
            if (charts.evDepreciation) charts.evDepreciation.destroy();
            
            const evData = filteredData.filter(car => car.fuel === 'Electric');
            const gasData = filteredData.filter(car => car.fuel === 'Gas');
            const hybridData = filteredData.filter(car => car.fuel === 'Hybrid' || car.fuel === 'PHEV');
            
            charts.evDepreciation = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: evData.map(car => car.name.replace(' ', '\\n')),
                    datasets: [{
                        label: 'EV Depreciation %',
                        data: evData.map(car => car.depreciation),
                        backgroundColor: evData.map(car => getCarColor(car)),
                        borderColor: evData.map(car => getCarColor(car)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = evData[context.dataIndex];
                                    const loss = car.price * car.depreciation / 100;
                                    return `${car.name}: ${car.depreciation}% = $${loss.toLocaleString()} loss`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            title: { display: true, text: 'Depreciation Percentage (%)' },
                            ticks: { callback: function(value) { return value + '%'; } }
                        }
                    }
                }
            });
        }

        function createHiddenCostsChart() {
            const ctx = document.getElementById('hiddenCostsChart').getContext('2d');
            if (charts.hiddenCosts) charts.hiddenCosts.destroy();
            
            const sampleCars = filteredData.slice(0, 8);
            
            charts.hiddenCosts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sampleCars.map(car => car.name.replace(' ', '\\n')),
                    datasets: [
                        {
                            label: 'Depreciation',
                            data: sampleCars.map(car => car.price * car.depreciation / 100),
                            backgroundColor: '#e74c3c', // Keep cost categories consistent
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Fuel (3yr)',
                            data: sampleCars.map(car => car.fuelCost * 3),
                            backgroundColor: '#f39c12', // Keep cost categories consistent
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Maintenance (3yr)',
                            data: sampleCars.map(car => car.maintenanceCost * 3),
                            backgroundColor: '#3498db', // Keep cost categories consistent
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Insurance (3yr)',
                            data: sampleCars.map(car => car.insuranceCost * 3),
                            backgroundColor: '#9b59b6', // Keep cost categories consistent
                            stack: 'Stack 0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Cost ($)' },
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        x: { stacked: true }
                    }
                }
            });
        }

        function createCategoryTCOChart() {
            const ctx = document.getElementById('categoryTCOChart').getContext('2d');
            if (charts.categoryTCO) charts.categoryTCO.destroy();
            
            const categories = {};
            filteredData.forEach(car => {
                if (!categories[car.category]) {
                    categories[car.category] = [];
                }
                categories[car.category].push(car.tco);
            });

            const categoryData = Object.keys(categories).map(cat => ({
                category: cat,
                avgTCO: categories[cat].reduce((sum, tco) => sum + tco, 0) / categories[cat].length,
                minTCO: Math.min(...categories[cat]),
                maxTCO: Math.max(...categories[cat]),
                count: categories[cat].length
            })).sort((a, b) => a.avgTCO - b.avgTCO);

            charts.categoryTCO = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryData.map(c => `${c.category}\\n(${c.count} cars)`),
                    datasets: [{
                        label: 'Average TCO',
                        data: categoryData.map(c => c.avgTCO),
                        backgroundColor: categoryData.map(c => {
                            if (c.avgTCO < 20000) return '#2ecc71';
                            if (c.avgTCO < 25000) return '#f39c12';
                            if (c.avgTCO < 30000) return '#e67e22';
                            return '#e74c3c';
                        }),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const cat = categoryData[context.dataIndex];
                                    return `${cat.category}: $${context.parsed.y.toLocaleString()} avg TCO`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Average TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createReliabilityMaintenanceChart() {
            const ctx = document.getElementById('reliabilityMaintenanceChart').getContext('2d');
            if (charts.reliabilityMaintenance) charts.reliabilityMaintenance.destroy();
            
            charts.reliabilityMaintenance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: filteredData.map(car => ({
                            x: car.reliability,
                            y: car.maintenanceCost,
                            label: car.name
                        })),
                        backgroundColor: filteredData.map(car => {
                            return getCarColor(car);
                        }),
                        pointRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = filteredData[context.dataIndex];
                                    return `${car.name}: ${car.reliability}/10 reliability, $${car.maintenanceCost.toLocaleString()}/yr maintenance`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Reliability Score (1-10)' } },
                        y: { 
                            title: { display: true, text: 'Annual Maintenance Cost ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStyleTCOChart() {
            const ctx = document.getElementById('styleTCOChart').getContext('2d');
            if (charts.styleTCO) charts.styleTCO.destroy();
            
            // Add default founder credibility scores for cars missing them
            const styledCars = filteredData.map(car => {
                if (car.founderCredibility) return car;
                
                // Assign default credibility based on brand/category
                let defaultCredibility = 4; // Default baseline
                
                if (car.brand === 'Tesla') defaultCredibility = 6;
                else if (car.brand === 'Porsche') defaultCredibility = 10;
                else if (car.brand === 'BMW') defaultCredibility = 8;
                else if (car.brand === 'Mercedes') defaultCredibility = 8;
                else if (car.brand === 'Audi') defaultCredibility = 7;
                else if (car.brand === 'Lexus') defaultCredibility = 6;
                else if (car.brand === 'Genesis') defaultCredibility = 7;
                else if (car.brand === 'Range Rover') defaultCredibility = 9;
                else if (car.brand === 'Honda' && car.name.includes('Type R')) defaultCredibility = 7;
                else if (car.brand === 'Honda') defaultCredibility = 4;
                else if (car.brand === 'Toyota' && car.name.includes('RAV4')) defaultCredibility = 6;
                else if (car.brand === 'Toyota') defaultCredibility = 4;
                else if (car.brand === 'Chevrolet') defaultCredibility = 3;
                else if (car.brand === 'Nissan') defaultCredibility = 3;
                else if (car.brand === 'Hyundai' || car.brand === 'Kia') defaultCredibility = 4;
                else if (car.brand === 'Ford') defaultCredibility = 5;
                else if (car.brand === 'Scion') defaultCredibility = 3;
                
                return {...car, founderCredibility: defaultCredibility};
            });
            
            charts.styleTCO = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: styledCars.map(car => ({
                            x: car.founderCredibility,
                            y: car.tco,
                            label: car.name,
                            car: car
                        })),
                        backgroundColor: styledCars.map(car => getCarColor(car)),
                        pointRadius: 10,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const car = styledCars[dataIndex];
                            showCarModal(car);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const car = styledCars[context.dataIndex];
                                    return `${car.name}: Style ${car.founderCredibility}/10, TCO $${car.tco.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Founder Credibility/Style Score (1-10)' },
                            min: 0, max: 10
                        },
                        y: {
                            title: { display: true, text: '3-Year TCO ($)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAllCharts() {
            createTCOReliabilityChart();
            createDepreciationChart();
            createTCOBrandChart();
            createFuelTypeChart();
            createMaintenanceChart();
            createInsuranceChart();
            createEVDepreciationChart();
            createHiddenCostsChart();
            createCategoryTCOChart();
            createReliabilityMaintenanceChart();
            createStyleTCOChart();
        }
        
        // Color toggle functionality
        function getCarColor(car, mode) {
            if (!mode) {
                mode = document.getElementById('colorMode') ? document.getElementById('colorMode').value : 'fuel';
            }
            
            if (mode === 'brand') {
                const brandColors = {
                    'Tesla': '#e74c3c',
                    'Honda': '#27ae60', 
                    'Toyota': '#f39c12',
                    'BMW': '#3498db',
                    'Mercedes': '#9b59b6',
                    'Audi': '#e67e22',
                    'Genesis': '#34495e',
                    'Lexus': '#1abc9c',
                    'Porsche': '#f1c40f',
                    'Chevrolet': '#c0392b',
                    'Hyundai': '#8e44ad',
                    'Kia': '#16a085',
                    'Nissan': '#2980b9',
                    'Volkswagen': '#95a5a6',
                    'Ford': '#d35400',
                    'Polestar': '#7f8c8d',
                    'Scion': '#2ecc71',
                    'Range Rover': '#8e44ad',
                    'Acura': '#3498db',
                    'Infiniti': '#e67e22',
                    'Lincoln': '#34495e',
                    'Mazda': '#e74c3c',
                    'Subaru': '#16a085',
                    'Volvo': '#95a5a6',
                    'Alfa Romeo': '#c0392b',
                    'Mini': '#f39c12',
                    'Cadillac': '#9b59b6'
                };
                return brandColors[car.brand] || '#bdc3c7';
            } else {
                // Fuel type colors
                if (car.fuel === 'Electric') return '#e74c3c';
                if (car.fuel === 'Hybrid' || car.fuel === 'PHEV') return '#27ae60';
                return '#3498db';
            }
        }

        // Optimized dashboard update with loading state
        function updateDashboard() {
            // Show loading state
            const containers = document.querySelectorAll('.chart-container, .stats-grid, .table-container');
            containers.forEach(container => {
                container.style.opacity = '0.6';
                container.style.pointerEvents = 'none';
            });

            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                // Destroy charts efficiently
                Object.values(charts).forEach(chart => {
                    if (chart && chart.destroy) chart.destroy();
                });
                charts = {};

                updateStats();
                updateTable();
                
                // Create charts with slight delay for better UX
                setTimeout(() => {
                    createAllCharts();
                    
                    // Remove loading state
                    containers.forEach(container => {
                        container.style.opacity = '1';
                        container.style.pointerEvents = 'auto';
                    });
                }, 100);
            });
        }

        // Setup event listeners with performance optimization
        function setupEventListeners() {
            // Use debounced filters for better performance
            document.getElementById('budgetFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('fuelFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('reliabilityFilter').addEventListener('change', debouncedApplyFilters);
            document.getElementById('brandFilter').addEventListener('change', debouncedApplyFilters);
            
            // Color toggle event listener
            document.getElementById('colorMode').addEventListener('change', updateDashboard);

            // Add loading states
            [document.getElementById('budgetFilter'), document.getElementById('fuelFilter'), 
             document.getElementById('reliabilityFilter'), document.getElementById('brandFilter')].forEach(filter => {
                filter.addEventListener('change', () => {
                    document.body.classList.add('loading');
                    setTimeout(() => document.body.classList.remove('loading'), 500);
                });
            });

            // Modal close with accessibility
            document.querySelector('.close').onclick = closeModal;
            document.querySelector('.close').onkeypress = function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    closeModal();
                }
            };
            
            window.onclick = function(event) {
                if (event.target === document.getElementById('carModal')) {
                    closeModal();
                }
            };
        }

        // Accessibility improvements
        function enhanceAccessibility() {
            // Add ARIA labels and roles
            document.querySelectorAll('.stat-card').forEach((card, index) => {
                card.setAttribute('role', 'article');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Statistics card ${index + 1}`);
            });

            document.querySelectorAll('.chart-container').forEach((container, index) => {
                container.setAttribute('role', 'img');
                const title = container.querySelector('.chart-title').textContent;
                container.setAttribute('aria-label', `Chart: ${title}`);
            });

            // Keyboard navigation for table
            document.addEventListener('keydown', (e) => {
                if (e.target.closest('.data-table') && e.key === 'Enter') {
                    e.target.click();
                }
            });
        }

        // Performance monitoring
        function monitorPerformance() {
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.entryType === 'measure' && entry.duration > 100) {
                            console.warn(`Slow operation detected: ${entry.name} took ${entry.duration}ms`);
                        }
                    });
                });
                observer.observe({ entryTypes: ['measure'] });
            }
        }

        // Initialize
        function init() {
            performance.mark('init-start');
            
            populateBrandFilter();
            updateDashboard();
            setupEventListeners();
            enhanceAccessibility();
            monitorPerformance();
            
            performance.mark('init-end');
            performance.measure('Dashboard Initialization', 'init-start', 'init-end');
            
            // Add loading complete indicator
            document.body.classList.add('loaded');
        }

        // Optimized event listener with passive flag where possible
        window.addEventListener('load', init, { passive: true });
        
        // Add error handling
        window.addEventListener('error', (e) => {
            console.error('Dashboard error:', e.error);
            // Could implement user-friendly error display here
        });
    </script>
</body>
</html>