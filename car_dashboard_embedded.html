<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Analysis Dashboard - Real Market Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 30px;
        }
        
        .filters {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(52, 73, 94, 0.1);
            border-radius: 10px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .chart-canvas {
            position: relative;
            height: 400px;
        }

        .top-picks {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .pick-card {
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.05);
        }

        .pick-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .pick-car {
            font-size: 1.3em;
            color: #3498db;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .pick-details {
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        
        #loading {
            text-align: center;
            font-size: 1.5em;
            color: #2c3e50;
            padding: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš— Car Analysis Dashboard</h1>
        <p class="subtitle">Real Market Data from KBB & Edmunds - For Founding Engineers in SF</p>
        
        <div id="loading">Loading car market data...</div>
        
        <div id="content" style="display: none;">
            <div class="filters">
                <div class="filter-group">
                    <label for="budgetFilter">Budget Range</label>
                    <select id="budgetFilter">
                        <option value="all">All Budgets</option>
                        <option value="under20k">Under $20k</option>
                        <option value="20to30k">$20k - $30k</option>
                        <option value="30to40k">$30k - $40k</option>
                        <option value="over40k">Over $40k</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="brandFilter">Brand</label>
                    <select id="brandFilter">
                        <option value="all">All Brands</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="fuelFilter">Fuel Type</label>
                    <select id="fuelFilter">
                        <option value="all">All Types</option>
                        <option value="Electric">Electric</option>
                        <option value="Hybrid">Hybrid</option>
                        <option value="PHEV">PHEV</option>
                        <option value="Gas">Gas</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="reliabilityFilter">Min Reliability</label>
                    <select id="reliabilityFilter">
                        <option value="all">All Ratings</option>
                        <option value="7">7+ Rating</option>
                        <option value="8">8+ Rating</option>
                        <option value="9">9+ Rating</option>
                    </select>
                </div>
            </div>
            
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="top-picks">
                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">ðŸŽ¯ Top Picks for Founding Engineers</h2>
                <div class="picks-grid" id="topPicks">
                    <!-- Top picks will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">TCO vs Reliability</h3>
                    <div class="chart-canvas">
                        <canvas id="tcoReliabilityChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">TCO by Brand</h3>
                    <div class="chart-canvas">
                        <canvas id="tcoBrandChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Price vs Depreciation</h3>
                    <div class="chart-canvas">
                        <canvas id="depreciationChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">TCO by Category</h3>
                    <div class="chart-canvas">
                        <canvas id="tcoCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Embedded CSV data to avoid CORS issues
        const csvData = \`make,model,year_range,price_range_low,price_range_high,category,drivetrain,fuel_type,mpg_city,mpg_highway,mpg_combined,annual_fuel_cost,maintenance_annual,insurance_annual,depreciation_3yr_percent,federal_tax_credit,ca_rebate,manufacturer_incentive,final_price_low,final_price_high,tco_3yr_low,tco_3yr_high,founder_credibility_score,reliability_score,notes
Tesla,Model 3,2019-2024,18000,33000,Premium EV,RWD/AWD,Electric,120,112,116,275,300,400,45,7500,2000,0,8500,23500,6575,16075,7,8,"2024: $26k-$44k new, 2023: $22k-$34k used, 2022: $19k-$28k used - massive depreciation"
Tesla,Model Y,2020-2024,30000,45000,Premium EV SUV,RWD/AWD,Electric,129,120,125,275,300,450,32,7500,2000,0,20500,35500,14750,22600,7,8,"Popular SUV option in tech circles"
Tesla,Model S,2018-2024,35000,65000,Luxury EV Sedan,AWD,Electric,120,115,118,275,400,500,35,0,0,0,35000,65000,24275,42775,8,7,"OG luxury EV - actual status symbol"
BMW,i4,2022-2024,40000,55000,Luxury EV,RWD/AWD,Electric,120,108,114,275,500,450,28,7500,2000,0,30500,45500,20075,29325,9,8,"German luxury EV credibility"
BMW,330e,2020-2022,23000,27500,Luxury PHEV,RWD/AWD,PHEV,75,85,80,400,800,350,38,0,0,0,23000,27500,17050,20350,8,7,"2022: $27k resale, 2021: $21k resale - 38-39% depreciation per KBB/Edmunds"
BMW,330i,2018-2022,20000,32000,Luxury Sedan,RWD/AWD,Gas,26,35,30,1200,800,350,28,0,0,0,20000,32000,16100,24600,8,7,"Classic luxury sedan"
BMW,M240i,2018-2023,30000,42000,Sports Luxury,RWD/AWD,Gas,22,32,25,1400,900,500,30,0,0,0,30000,42000,22300,30900,9,7,"Performance credibility"
BMW,M2,2018-2023,35000,50000,Sports Car,RWD,Gas,20,28,22,1600,1000,600,25,0,0,0,35000,50000,26400,35900,9,7,"True enthusiast car"
Audi,A4,2018-2022,22000,32000,Luxury Sedan,AWD,Gas,27,34,30,1200,900,400,30,0,0,0,22000,32000,17700,25700,8,7,"European sophistication"
Audi,S4,2018-2022,28000,40000,Sports Luxury,AWD,Gas,21,30,24,1500,1000,500,32,0,0,0,28000,40000,22100,30500,9,7,"Understated performance"
Genesis,G70,2020-2022,20000,29000,Luxury Sedan,RWD/AWD,Gas,22,31,25,1400,600,300,43,0,0,2000,18000,27000,14700,20900,8,8,"2022: $21k-$24k resale per KBB/Edmunds, 43% depreciation but excellent warranty"
Genesis,G80,2021-2024,28000,42000,Luxury Sedan,RWD/AWD,Gas,22,32,25,1400,700,350,33,0,0,2000,26000,40000,19700,28750,8,8,"Executive presence"
Genesis,GV70,2022-2024,35000,48000,Luxury SUV,AWD,Gas,22,28,24,1500,700,400,30,0,0,2000,33000,46000,25200,33400,8,8,"Luxury SUV with value story"
Genesis,GV60,2022-2024,45000,60000,Luxury EV SUV,AWD,Electric,112,112,112,275,500,450,35,7500,2000,0,35500,50500,22675,31325,9,8,"Cutting-edge luxury EV"
Mercedes,C300,2018-2022,25000,35000,Luxury Sedan,RWD/AWD,Gas,23,32,26,1300,1000,400,32,0,0,0,25000,35000,20300,28300,8,6,"Classic luxury badge"
Mercedes,CLA250,2019-2024,22000,32000,Luxury Sedan,FWD/AWD,Gas,24,35,28,1200,900,400,35,0,0,0,22000,32000,18500,26500,7,6,"Entry luxury - compact"
Porsche,Cayman,2017-2023,32000,57000,Sports Car,RWD,Gas,20,28,22,1600,1200,700,22,0,0,0,32000,57000,26700,40200,10,9,"2019: $29k-$54k, 2021: $32k-$57k per Edmunds - excellent retention"
Porsche,Boxster,2017-2023,30000,50000,Sports Convertible,RWD,Gas,20,28,22,1600,1200,700,22,0,0,0,30000,50000,24700,35700,10,9,"Convertible sports luxury"
Porsche,Macan,2018-2023,35000,50000,Luxury SUV,AWD,Gas,19,25,21,1700,1200,600,25,0,0,0,35000,50000,27900,37400,10,8,"Luxury SUV pinnacle"
Lexus,IS,2018-2024,22000,32000,Luxury Sedan,RWD/AWD,Gas,21,31,24,1500,400,300,25,0,0,0,22000,32000,16900,24400,7,9,"Reliable luxury"
Lexus,ES Hybrid,2019-2024,28000,40000,Luxury Hybrid,FWD,Hybrid,43,44,44,700,400,300,27,0,0,0,28000,40000,19400,26800,7,9,"2022: $32k resale per KBB - excellent 27% depreciation, Toyota hybrid reliability"
Acura,TLX,2018-2024,24000,35000,Luxury Sedan,FWD/AWD,Gas,22,31,25,1400,500,300,28,0,0,0,24000,35000,18700,26650,7,8,"2023: $26k-$51k per Edmunds, avg $26k market - Honda luxury reliability"
Acura,RDX,2019-2024,25000,35000,Luxury SUV,AWD,Gas,22,28,24,1500,600,350,28,0,0,0,25000,35000,19450,26950,7,8,"Reliable luxury SUV"
Toyota,RAV4 Hybrid,2021-2023,24000,37000,Hybrid SUV,AWD,Hybrid,41,38,40,800,400,200,15,0,0,0,24000,37000,17200,25400,6,9,"2023: $25k-$37k, 2021: $20k-$32k per Edmunds - best-in-class retention at 12% depreciation"
Toyota,Camry Hybrid,2018-2024,23000,32000,Hybrid Sedan,FWD,Hybrid,51,53,52,600,400,200,22,0,0,1000,22000,31000,16000,22200,5,9,"Efficiency champion"
Toyota,Prius,2018-2024,18000,28000,Hybrid Hatchback,FWD,Hybrid,54,50,52,600,300,200,25,0,0,1000,17000,27000,12550,19050,4,9,"Maximum efficiency"
Toyota,Prius Prime,2018-2024,20000,30000,PHEV Hatchback,FWD,PHEV,114,99,106,350,350,250,28,0,0,1000,19000,29000,13250,20250,5,9,"PHEV efficiency leader"
Toyota,GR86,2022-2024,25000,32000,Sports Car,RWD,Gas,20,27,22,1600,400,400,25,0,0,0,25000,32000,19700,25200,7,8,"Affordable sports car fun"
Honda,Accord Hybrid,2018-2024,22000,30000,Hybrid Sedan,FWD,Hybrid,48,47,48,650,500,250,25,0,0,500,21500,29500,15650,21650,6,9,"Reliable hybrid sedan"
Honda,CR-V Hybrid,2020-2024,25000,33000,Hybrid SUV,AWD,Hybrid,40,35,38,850,500,250,24,0,0,0,25000,33000,18350,24350,6,8,"Practical hybrid SUV"
Honda,Civic,2018-2024,14000,28000,Compact Sedan,FWD,Gas,32,42,35,1000,400,200,31,0,0,500,13500,27500,11900,20900,4,9,"2022: $16k-$28k, 2021: $15k-$38k per Edmunds - excellent 31% depreciation for class"
Hyundai,Ioniq 5,2022-2024,20000,32000,EV SUV,RWD/AWD,Electric,114,94,104,275,400,350,52,7500,2000,0,10500,22500,9075,15075,8,7,"2023: $24k resale, 2022: $21k resale per KBB - massive 52% EV depreciation but great value"
Hyundai,Elantra Hybrid,2021-2024,20000,26000,Hybrid Sedan,FWD,Hybrid,53,56,54,600,500,250,35,0,0,0,20000,26000,15100,19600,4,7,"Budget hybrid option"
Kia,EV6,2022-2024,30000,42000,EV SUV,RWD/AWD,Electric,117,94,105,275,400,350,42,7500,2000,0,20500,32500,13575,21075,7,7,"Korean EV innovation"
Kia,Stinger,2018-2022,22000,32000,Sports Sedan,RWD/AWD,Gas,22,29,25,1400,600,350,40,0,0,0,22000,32000,18100,25600,7,7,"Unexpected performance"
Chevrolet,Bolt EUV,2022-2024,16000,24000,EV SUV,FWD,Electric,120,108,114,275,600,300,55,7500,2000,2000,6500,14500,6575,11575,5,6,"2023: $16k-$24k per Edmunds - 38% depreciation in 2 years, great value"
Chevrolet,Bolt EV,2020-2024,13000,21000,EV Hatchback,FWD,Electric,120,108,114,275,600,300,55,7500,2000,2000,3500,11500,5075,9575,4,6,"2022: $13k-$21k per Edmunds - 55% depreciation but cheapest EV available"
Nissan,Leaf,2018-2024,12000,25000,EV Hatchback,FWD,Electric,111,123,117,275,500,300,60,0,0,0,12000,25000,9275,17775,4,5,"Avoid older models - battery issues"
Volkswagen,ID.4,2021-2024,25000,35000,EV SUV,RWD/AWD,Electric,104,89,97,275,700,350,45,7500,2000,0,15500,25500,11325,17825,6,6,"German EV alternative"
Volvo,S60,2019-2024,22000,32000,Luxury Sedan,FWD/AWD,Gas,23,34,27,1250,800,400,35,0,0,0,22000,32000,18150,25650,7,8,"Swedish safety luxury"
Volvo,XC60,2018-2024,25000,40000,Luxury SUV,AWD,Gas,22,29,25,1400,900,450,32,0,0,0,25000,40000,20700,29700,7,8,"Safety-focused luxury SUV"
Alfa Romeo,Giulia,2017-2023,25000,40000,Luxury Sedan,RWD/AWD,Gas,24,33,27,1250,1200,500,45,0,0,0,25000,40000,21950,31450,9,4,"Gorgeous but unreliable"
Infiniti,Q50,2018-2024,18000,28000,Luxury Sedan,RWD/AWD,Gas,20,29,23,1550,700,350,35,0,0,0,18000,28000,15550,22550,6,6,"Nissan luxury platform"
Lincoln,Continental,2017-2020,20000,30000,Luxury Sedan,AWD,Gas,16,24,19,1800,800,400,40,0,0,0,20000,30000,18100,25600,6,6,"American luxury value"
Mazda,CX-5,2020-2024,18000,30000,Compact SUV,AWD,Gas,24,30,26,1200,600,350,30,0,0,0,18000,30000,15600,23400,6,8,"2023: $18k-$30k, 2022: $17k-$28k per Edmunds - solid 30% depreciation, reliable"
Subaru,Outback,2020-2024,22000,32000,Wagon SUV,AWD,Gas,26,33,29,1100,700,400,28,0,0,0,22000,32000,18100,25600,5,9,"AWD standard, excellent reliability, practical wagon design"
Volkswagen,Golf GTI,2019-2024,20000,30000,Sports Compact,FWD,Gas,24,32,27,1200,800,450,35,0,0,0,20000,30000,17500,25350,7,6,"Hot hatch enthusiast favorite, higher maintenance costs"
Mini,Cooper S,2019-2024,18000,28000,Premium Compact,FWD,Gas,26,34,29,1150,900,500,40,0,0,0,18000,28000,17100,25200,8,5,"Premium small car with style, BMW reliability concerns"\`;

        let carData = [];
        let charts = {};
        
        // Parse CSV line handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }
        
        // Load data from embedded CSV
        function loadData() {
            try {
                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',');
                
                carData = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const car = {};
                    headers.forEach((header, index) => {
                        let value = values[index] || '';
                        
                        // Convert numeric fields
                        if (['price_range_low', 'price_range_high', 'annual_fuel_cost', 'tco_3yr_low', 'tco_3yr_high', 
                             'founder_credibility_score', 'reliability_score', 'depreciation_3yr_percent',
                             'maintenance_annual', 'insurance_annual', 'mpg_combined'].includes(header)) {
                            value = parseFloat(value) || 0;
                        }
                        
                        car[header] = value;
                    });
                    return car;
                });
                
                console.log(`Loaded ${carData.length} cars from embedded CSV`);
                return true;
                
            } catch (error) {
                console.error('Error parsing embedded CSV:', error);
                return false;
            }
        }
        
        // Get filtered data based on current filters
        function getFilteredData() {
            let filtered = [...carData];
            
            // Budget filter
            const budgetFilter = document.getElementById('budgetFilter')?.value;
            if (budgetFilter && budgetFilter !== 'all') {
                filtered = filtered.filter(car => {
                    const avgPrice = (car.price_range_low + car.price_range_high) / 2;
                    switch(budgetFilter) {
                        case 'under20k': return avgPrice < 20000;
                        case '20to30k': return avgPrice >= 20000 && avgPrice < 30000;
                        case '30to40k': return avgPrice >= 30000 && avgPrice < 40000;
                        case 'over40k': return avgPrice >= 40000;
                        default: return true;
                    }
                });
            }
            
            // Brand filter
            const brandFilter = document.getElementById('brandFilter')?.value;
            if (brandFilter && brandFilter !== 'all') {
                filtered = filtered.filter(car => car.make === brandFilter);
            }
            
            // Fuel filter
            const fuelFilter = document.getElementById('fuelFilter')?.value;
            if (fuelFilter && fuelFilter !== 'all') {
                filtered = filtered.filter(car => car.fuel_type === fuelFilter);
            }
            
            // Reliability filter
            const reliabilityFilter = document.getElementById('reliabilityFilter')?.value;
            if (reliabilityFilter && reliabilityFilter !== 'all') {
                const minReliability = parseInt(reliabilityFilter);
                filtered = filtered.filter(car => car.reliability_score >= minReliability);
            }
            
            return filtered;
        }
        
        // Populate brand filter with unique brands
        function populateBrandFilter() {
            const brandFilter = document.getElementById('brandFilter');
            const brands = [...new Set(carData.map(car => car.make))].sort();
            
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });
        }

        // Update top picks
        function updateTopPicks() {
            const filtered = getFilteredData();
            if (filtered.length === 0) return;
            
            // Calculate best picks
            const bestTCO = filtered.reduce((best, car) => {
                const carTCO = (car.tco_3yr_low + car.tco_3yr_high) / 2;
                const bestTCO = (best.tco_3yr_low + best.tco_3yr_high) / 2;
                return carTCO < bestTCO ? car : best;
            });

            const bestReliability = filtered.reduce((best, car) => 
                car.reliability_score > best.reliability_score ? car : best
            );

            const bestEV = filtered.filter(car => car.fuel_type === 'Electric')
                .reduce((best, car) => {
                    if (!best) return car;
                    const carTCO = (car.tco_3yr_low + car.tco_3yr_high) / 2;
                    const bestTCO = (best.tco_3yr_low + best.tco_3yr_high) / 2;
                    return carTCO < bestTCO ? car : best;
                }, null);

            const topPicksDiv = document.getElementById('topPicks');
            let html = `
                <div class="pick-card">
                    <div class="pick-title">ðŸ’° Best TCO</div>
                    <div class="pick-car">${bestTCO.make} ${bestTCO.model}</div>
                    <div class="pick-details">
                        $${((bestTCO.tco_3yr_low + bestTCO.tco_3yr_high) / 2).toLocaleString()} TCO<br>
                        ${bestTCO.reliability_score}/10 reliability<br>
                        $${bestTCO.price_range_low.toLocaleString()} - $${bestTCO.price_range_high.toLocaleString()}
                    </div>
                </div>
                
                <div class="pick-card">
                    <div class="pick-title">ðŸ”§ Most Reliable</div>
                    <div class="pick-car">${bestReliability.make} ${bestReliability.model}</div>
                    <div class="pick-details">
                        ${bestReliability.reliability_score}/10 reliability<br>
                        $${((bestReliability.tco_3yr_low + bestReliability.tco_3yr_high) / 2).toLocaleString()} TCO<br>
                        $${bestReliability.price_range_low.toLocaleString()} - $${bestReliability.price_range_high.toLocaleString()}
                    </div>
                </div>
            `;

            if (bestEV) {
                html += `
                    <div class="pick-card">
                        <div class="pick-title">âš¡ Best EV Value</div>
                        <div class="pick-car">${bestEV.make} ${bestEV.model}</div>
                        <div class="pick-details">
                            $${((bestEV.tco_3yr_low + bestEV.tco_3yr_high) / 2).toLocaleString()} TCO<br>
                            ${bestEV.reliability_score}/10 reliability<br>
                            $${bestEV.price_range_low.toLocaleString()} - $${bestEV.price_range_high.toLocaleString()}
                        </div>
                    </div>
                `;
            }

            topPicksDiv.innerHTML = html;
        }
        
        // Update statistics
        function updateStats() {
            const filtered = getFilteredData();
            if (filtered.length === 0) return;
            
            const avgTCO = filtered.reduce((sum, car) => sum + (car.tco_3yr_low + car.tco_3yr_high) / 2, 0) / filtered.length;
            const avgReliability = filtered.reduce((sum, car) => sum + car.reliability_score, 0) / filtered.length;
            const avgDepreciation = filtered.reduce((sum, car) => sum + car.depreciation_3yr_percent, 0) / filtered.length;
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${filtered.length}</div>
                    <div class="stat-label">Cars Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${Math.round(avgTCO).toLocaleString()}</div>
                    <div class="stat-label">Average 3-Year TCO</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgReliability.toFixed(1)}</div>
                    <div class="stat-label">Average Reliability</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgDepreciation.toFixed(0)}%</div>
                    <div class="stat-label">Average Depreciation</div>
                </div>
            `;
        }
        
        // Create TCO vs Reliability chart
        function createTCOVsReliabilityChart() {
            const ctx = document.getElementById('tcoReliabilityChart').getContext('2d');
            const filtered = getFilteredData();
            
            const data = filtered.map(car => ({
                x: car.reliability_score,
                y: (car.tco_3yr_low + car.tco_3yr_high) / 2,
                label: `${car.make} ${car.model}`,
                color: car.fuel_type === 'Electric' ? '#3498db' : 
                       car.fuel_type === 'Hybrid' || car.fuel_type === 'PHEV' ? '#2ecc71' : '#e74c3c'
            }));
            
            if (charts.tcoReliability) charts.tcoReliability.destroy();
            charts.tcoReliability = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: data,
                        backgroundColor: data.map(d => d.color),
                        borderColor: data.map(d => d.color),
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Reliability Score'
                            },
                            min: 4,
                            max: 10
                        },
                        y: {
                            title: {
                                display: true,
                                text: '3-Year TCO ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = data[context.dataIndex];
                                    return `${point.label}: $${context.parsed.y.toLocaleString()} TCO, ${context.parsed.x} reliability`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Create TCO by Brand chart
        function createTCOByBrandChart() {
            const ctx = document.getElementById('tcoBrandChart').getContext('2d');
            const filtered = getFilteredData();
            
            // Group by brand and calculate average TCO
            const brands = {};
            filtered.forEach(car => {
                if (!brands[car.make]) {
                    brands[car.make] = [];
                }
                brands[car.make].push((car.tco_3yr_low + car.tco_3yr_high) / 2);
            });
            
            const brandData = Object.keys(brands)
                .map(brand => ({
                    brand: brand,
                    avgTCO: brands[brand].reduce((sum, tco) => sum + tco, 0) / brands[brand].length,
                    count: brands[brand].length
                }))
                .sort((a, b) => a.avgTCO - b.avgTCO);
            
            if (charts.tcoBrand) charts.tcoBrand.destroy();
            charts.tcoBrand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brandData.map(b => b.brand),
                    datasets: [{
                        data: brandData.map(b => b.avgTCO),
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Average 3-Year TCO ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const brand = brandData[context.dataIndex];
                                    return `${brand.brand}: $${context.parsed.y.toLocaleString()} avg (${brand.count} models)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create Depreciation chart
        function createDepreciationChart() {
            const ctx = document.getElementById('depreciationChart').getContext('2d');
            const filtered = getFilteredData();
            
            const data = filtered.map(car => ({
                x: (car.price_range_low + car.price_range_high) / 2,
                y: car.depreciation_3yr_percent,
                label: `${car.make} ${car.model}`,
                color: car.fuel_type === 'Electric' ? '#3498db' : 
                       car.fuel_type === 'Hybrid' || car.fuel_type === 'PHEV' ? '#2ecc71' : '#e74c3c'
            }));
            
            if (charts.depreciation) charts.depreciation.destroy();
            charts.depreciation = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Cars',
                        data: data,
                        backgroundColor: data.map(d => d.color),
                        borderColor: data.map(d => d.color),
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Average Price ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '3-Year Depreciation (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = data[context.dataIndex];
                                    return `${point.label}: $${context.parsed.x.toLocaleString()} avg price, ${context.parsed.y}% depreciation`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Create TCO by Category chart
        function createTCOByCategoryChart() {
            const ctx = document.getElementById('tcoCategoryChart').getContext('2d');
            const filtered = getFilteredData();
            
            // Group by simplified category
            const categories = {};
            filtered.forEach(car => {
                let category = car.category;
                // Simplify categories
                if (category.includes('EV') || car.fuel_type === 'Electric') category = 'Electric';
                else if (category.includes('Hybrid') || car.fuel_type === 'Hybrid' || car.fuel_type === 'PHEV') category = 'Hybrid';
                else if (category.includes('Sports')) category = 'Sports';
                else if (category.includes('Luxury')) category = 'Luxury';
                else if (category.includes('SUV')) category = 'SUV';
                else if (category.includes('Compact') || category.includes('Budget')) category = 'Compact';
                else category = 'Sedan';
                
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push((car.tco_3yr_low + car.tco_3yr_high) / 2);
            });
            
            const categoryData = Object.keys(categories).map(cat => ({
                category: cat,
                avgTCO: categories[cat].reduce((sum, tco) => sum + tco, 0) / categories[cat].length,
                count: categories[cat].length
            }));
            
            const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22'];
            
            if (charts.tcoCategory) charts.tcoCategory.destroy();
            charts.tcoCategory = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(c => `${c.category} ($${(c.avgTCO / 1000).toFixed(0)}k)`),
                    datasets: [{
                        data: categoryData.map(c => c.avgTCO),
                        backgroundColor: colors.slice(0, categoryData.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const cat = categoryData[context.dataIndex];
                                    return `${cat.category}: $${context.parsed.toLocaleString()} avg (${cat.count} cars)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create all charts
        function createCharts() {
            createTCOVsReliabilityChart();
            createTCOByBrandChart();
            createDepreciationChart();
            createTCOByCategoryChart();
        }
        
        // Setup filter event listeners
        function setupFilters() {
            ['budgetFilter', 'brandFilter', 'fuelFilter', 'reliabilityFilter'].forEach(filterId => {
                document.getElementById(filterId).addEventListener('change', updateDashboard);
            });
        }
        
        // Update dashboard with current filters
        function updateDashboard() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && chart.destroy) chart.destroy();
            });
            charts = {};
            
            // Recreate with filtered data
            updateStats();
            updateTopPicks();
            createCharts();
        }
        
        // Initialize dashboard
        function initDashboard() {
            const dataLoaded = loadData();
            if (!dataLoaded) {
                document.getElementById('loading').innerHTML = 'Error loading car data.';
                return;
            }
            
            populateBrandFilter();
            updateStats();
            updateTopPicks();
            createCharts();
            setupFilters();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
        
        // Start the dashboard when page loads
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>